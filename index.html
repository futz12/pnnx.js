<!doctype html>
<html lang="zh-CN" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PNNX åœ¨çº¿è½¬æ¢</title>
  <style>
    :root{
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;

      --bg:#f5f7fb;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --brand:#2563eb;
      --brand2:#1d4ed8;
      --danger:#dc2626;
      --ok:#16a34a;
      --shadow: 0 10px 24px rgba(0,0,0,.08);
      --radius:14px;

      --consoleBg:#0b1020;
      --consoleText:#b7ffb7;

      --pillBg:#fafafa;
      --panelBg:#fafafa;
      --modalMask: rgba(0,0,0,.55);

      --inputBg: #ffffff;
      --inputText: #111827;

      --controlH: 42px;
      --pad: 14px;
      --gap: 12px;

      --caret: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 24 24'%3E%3Cpath fill='%236b7280' d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
      --chev: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 24 24'%3E%3Cpath fill='%236b7280' d='M9 6l6 6-6 6'/%3E%3C/svg%3E");
    }
    html[data-theme="dark"]{
      --bg:#0b1020;
      --card:#0f172a;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --line: rgba(148,163,184,.18);
      --brand:#60a5fa;
      --brand2:#3b82f6;
      --danger:#fb7185;
      --ok:#34d399;
      --shadow: 0 12px 28px rgba(0,0,0,.35);

      --consoleBg:#050813;
      --consoleText:#a7ffb2;

      --pillBg: rgba(2,6,23,.35);
      --panelBg: rgba(2,6,23,.22);
      --modalMask: rgba(0,0,0,.65);

      --inputBg: rgba(2,6,23,.25);
      --inputText: #e5e7eb;

      --caret: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 24 24'%3E%3Cpath fill='%239ca3af' d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
      --chev: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 24 24'%3E%3Cpath fill='%239ca3af' d='M9 6l6 6-6 6'/%3E%3C/svg%3E");
    }

    html{ color-scheme: light; }
    html[data-theme="dark"]{ color-scheme: dark; }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    .wrap{ max-width: 1240px; margin: 0 auto; padding: 16px; }

    .header{
      background:var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: var(--pad);
      display:flex;
      gap: var(--gap);
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .title h1{ margin:0; font-size:18px; }
    .title p{ margin:6px 0 0; color:var(--muted); font-size:13px; line-height:1.35; }
    .status{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; color:var(--muted); font-size:12.5px; }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid var(--line);
      padding:8px 10px;
      border-radius:999px;
      background:var(--pillBg);
      backdrop-filter: blur(6px);
    }
    .dot{ width:9px; height:9px; border-radius:50%; background:#9ca3af; }
    .dot.ok{ background:var(--ok); }
    .dot.bad{ background:var(--danger); }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .body{ padding: var(--pad); }

    .main-grid{
      margin-top:12px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--gap);
      align-items:start;
    }
    @media(max-width:1050px){ .main-grid{ grid-template-columns:1fr; } }

    .section{
      border:1px solid var(--line);
      border-radius: 14px;
      background: var(--panelBg);
      padding: 12px;
    }
    .section + .section{ margin-top: 12px; }
    .h2{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 10px;
      font-weight:900;
      font-size:13px;
    }
    .hint{ margin-top:6px; color:var(--muted); font-size:12px; line-height:1.35; }
    .mono{ font-family: var(--mono); }

    .grid-2{ display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .grid-3{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
    @media(max-width:780px){ .grid-2, .grid-3{ grid-template-columns: 1fr; } }

    label{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      font-size:12px;
      color:var(--muted);
      margin: 0 0 6px;
    }

    input[type="text"], select, textarea{
      width:100%;
      height: var(--controlH);
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 12px;
      outline:none;
      background: var(--inputBg);
      color: var(--inputText);
      font-size:14px;
    }
    textarea{
      height:auto;
      min-height:84px;
      resize:vertical;
    }
    select{
      appearance:none;
      -webkit-appearance:none;
      -moz-appearance:none;
      padding-right: 40px;
      background-image: var(--caret);
      background-repeat:no-repeat;
      background-position: calc(100% - 12px) 50%;
      background-size: 18px 18px;
    }
    option{ color:#111827; background:#ffffff; }
    html[data-theme="dark"] option{ color:#e5e7eb; background:#0b1220; }

    .btnbar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top: 10px;
    }
    button{
      border:0;
      background: var(--brand);
      color:#fff;
      height: var(--controlH);
      padding:0 14px;
      border-radius:12px;
      font-weight:700;
      cursor:pointer;
      font-size:13px;
    }
    button:hover{ background: var(--brand2); }
    button:disabled{ background:#94a3b8; cursor:not-allowed; }
    .btn-secondary{
      background: rgba(148,163,184,.20);
      color: var(--text);
      border:1px solid var(--line);
    }
    .btn-secondary:hover{ background: rgba(148,163,184,.30); }
    .btn-ghost{
      background: rgba(37,99,235,.10);
      color: var(--text);
      border:1px solid var(--line);
    }
    .btn-ghost:hover{ background: rgba(37,99,235,.16); }
    .btn-danger{ background: var(--danger); }
    .btn-danger:hover{ filter: brightness(.95); }

    .checkrow{
      display:flex;
      align-items:center;
      gap:10px;
      margin-top: 10px;
      color:var(--muted);
      font-size: 12.5px;
      user-select:none;
    }
    .checkrow input{ width:auto; height:auto; transform: scale(1.08); }

    .shape-list{ display:flex; flex-direction:column; gap:10px; }
    .shape-row{
      display:grid;
      grid-template-columns: 1fr 160px 92px;
      gap: 10px;
      align-items:end;
    }
    @media(max-width:780px){
      .shape-row{ grid-template-columns: 1fr 160px; }
      .shape-row .del{ grid-column: 1 / -1; }
    }
    .preview{
      margin-top:10px;
      border:1px dashed var(--line);
      border-radius:12px;
      padding:10px 12px;
      background:transparent;
      font-family: var(--mono);
      font-size:12.5px;
      color:var(--text);
      white-space:pre-wrap;
      word-break:break-all;
    }

    details{
      border:1px solid var(--line);
      border-radius: 14px;
      overflow:hidden;
      background: transparent;
      margin-top: 12px;
    }
    details summary{
      cursor:pointer;
      list-style:none;
      padding: 12px 12px;
      font-weight:900;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      user-select:none;
    }
    details summary::-webkit-details-marker{ display:none; }
    details summary .rightcue{
      display:inline-flex;
      align-items:center;
      gap:8px;
      color:var(--muted);
      font-weight:700;
      font-size:12px;
    }
    details summary .chev{
      width:18px; height:18px;
      background-image: var(--chev);
      background-size: 18px 18px;
      background-repeat:no-repeat;
      background-position:center;
      transform: rotate(0deg);
      transition: transform .15s ease;
      opacity:.9;
    }
    details[open] summary .chev{ transform: rotate(90deg); }
    details .inner{
      padding: 12px;
      border-top:1px solid var(--line);
      background: var(--panelBg);
    }

    .console{
      border:1px solid var(--line);
      border-radius:12px;
      background:var(--consoleBg);
      color:var(--consoleText);
      padding:10px 12px;
      height: 270px;
      overflow:auto;
      font-family: var(--mono);
      font-size:12.5px;
      white-space: pre-wrap;
    }

    .log-actions{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .copy-btn{
      height: 32px;
      padding: 0 10px;
      border-radius: 10px;
      font-size: 12.5px;
      font-weight: 800;
      background: rgba(148,163,184,.18);
      color: var(--text);
      border: 1px solid var(--line);
    }
    .copy-btn:hover{ background: rgba(148,163,184,.28); }

    .tablewrap{
      border:1px solid var(--line);
      border-radius:12px;
      overflow:hidden;
      margin-top:10px;
      background: transparent;
    }
    table{ width:100%; border-collapse:collapse; }
    th, td{
      padding:10px 10px;
      border-bottom:1px solid var(--line);
      text-align:left;
      font-size:13px;
      vertical-align: middle;
    }
    th{ background:var(--panelBg); color:var(--muted); font-weight:900; }
    tr:last-child td{ border-bottom:none; }
    .right{ text-align:right; }

    .donate-fab{
      position:fixed;
      right: 16px;
      bottom: 16px;
      width: 56px;
      height: 56px;
      border-radius: 999px;
      background: var(--brand);
      color:#fff;
      box-shadow: var(--shadow);
      border: 1px solid rgba(255,255,255,.14);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      user-select:none;
      z-index: 1200;
      font-weight: 900;
      letter-spacing: .5px;
    }
    .donate-fab:hover{ background: var(--brand2); }

    .modal{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:2000;
      padding: 16px;
    }
    html[data-theme="dark"] .modal{ background: rgba(0,0,0,.65); }
    .modal.show{ display:flex; }
    .modal-card{
      width: min(860px, 100%);
      background: var(--card);
      border-radius: 16px;
      border:1px solid var(--line);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modal-head{
      padding: 12px 14px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .modal-head .t{ font-weight:900; }
    .modal-body{ padding: 14px; }
    .qr-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media(max-width:760px){ .qr-grid{ grid-template-columns:1fr; } }
    .qr-card{
      border:1px solid var(--line);
      border-radius:14px;
      padding: 12px;
      background:var(--panelBg);
    }
    .qr-card .h{ font-weight:900; margin-bottom:8px; }
    .qr-img{
      width:100%;
      aspect-ratio: 1 / 1;
      border:1px dashed var(--line);
      border-radius:12px;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      background: transparent;
    }
    .qr-img img{ width:100%; height:100%; object-fit:contain; }

    .footer{
      margin-top: 14px;
      padding: 12px 0 4px;
      color: var(--muted);
      font-size: 12.5px;
      text-align:center;
    }
    .footer a{ color: var(--brand); text-decoration:none; }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 92px;
      transform: translateX(-50%);
      background: rgba(17,24,39,.92);
      color: #fff;
      padding: 10px 12px;
      border-radius: 12px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(255,255,255,.12);
      z-index: 2500;
      display:none;
      font-size: 12.5px;
      font-weight: 800;
    }
    html[data-theme="dark"] .toast{ background: rgba(2,6,23,.92); }
    .toast.show{ display:block; }

    /* wasm ä¸‹è½½è¿›åº¦ */
    #dlPanel{
      position:fixed;left:16px;bottom:16px;z-index:2600;
      width:min(360px, calc(100vw - 32px));
      background: rgba(17,24,39,.90);
      color:#fff;
      border:1px solid rgba(255,255,255,.12);
      border-radius:14px;
      padding:10px 12px;
      box-shadow: var(--shadow);
      display:none;
    }

    /* è½¬æ¢é®ç½©åŠ¨ç”» */
    #busyOverlay, #dropOverlay{
      position: fixed;
      inset: 0;
      z-index: 3000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      background: rgba(0,0,0,.48);
      backdrop-filter: blur(6px);
    }
    html[data-theme="dark"] #busyOverlay,
    html[data-theme="dark"] #dropOverlay{
      background: rgba(0,0,0,.58);
    }
    .overlay-card{
      width: min(520px, 100%);
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 16px;
      box-shadow: var(--shadow);
      padding: 14px;
      display:flex;
      gap: 12px;
      align-items: center;
    }
    .spinner{
      width: 36px;
      height: 36px;
      border-radius: 999px;
      border: 4px solid rgba(148,163,184,.35);
      border-top-color: var(--brand);
      animation: spin 0.9s linear infinite;
      flex: 0 0 auto;
    }
    @keyframes spin{ to { transform: rotate(360deg); } }
    .overlay-text .t{ font-weight: 900; margin-bottom: 4px; }
    .overlay-text .d{ color: var(--muted); font-size: 12.5px; line-height: 1.35; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="title">
        <h1>PNNX åœ¨çº¿è½¬æ¢</h1>
        <p>æœ¬ç½‘ç«™åŸºäºwasmæŠ€æœ¯ï¼Œä¸ä¼šä¸Šä¼ æ‚¨çš„æ¨¡å‹ï¼Œè¯·æ”¾å¿ƒä½¿ç”¨ã€‚</p>
      </div>
      <div class="status">
        <div class="pill"><span class="dot" id="dotWasm"></span><span id="wasmStatus">WASM åŠ è½½ä¸­â€¦</span></div>
        <div class="pill">
          <button id="themeBtn" class="btn-secondary" type="button" style="height:34px;padding:0 12px;border-radius:999px;">åˆ‡æ¢æ·±è‰²/æµ…è‰²</button>
        </div>
      </div>
    </div>

    <div class="main-grid">
      <div class="card">
        <div class="body">
          <div class="section">
            <div class="h2">æ¨¡å‹</div>

            <input type="file" id="modelFile" accept=".pt,.onnx" style="display:none">

            <div id="dropzone" style="
              border:1px dashed var(--line);
              border-radius:14px;
              padding:14px;
              background: transparent;
              display:flex;
              align-items:center;
              justify-content:space-between;
              gap:12px;
            ">
              <div>
                <div style="font-weight:900;">æ‹–æ‹½æ¨¡å‹åˆ°ç½‘é¡µä»»æ„ä½ç½®å³å¯å¯¼å…¥</div>
                <div class="hint" style="margin-top:4px;">æˆ–ç‚¹å‡»å³ä¾§æŒ‰é’®é€‰æ‹©æ–‡ä»¶ï¼ˆæ”¯æŒ .pt / .onnxï¼Œä¸æ”¯æŒ .pthï¼‰</div>
                <div class="hint" id="modelHint" style="margin-top:6px;">å½“å‰æ¨¡å‹ï¼šæ— </div>
              </div>
              <button class="btn-ghost" id="pickFileBtn" type="button">é€‰æ‹©æ¨¡å‹æ–‡ä»¶</button>
            </div>

            <div class="btnbar">
              <button id="runBtn" disabled>åŠ è½½ WASM ä¸­â€¦</button>
              <button class="btn-secondary" id="clearLogBtn" disabled>æ¸…ç©ºæ—¥å¿—</button>
              <button class="btn-danger" id="clearWorkBtn" disabled>æ¸…ç©ºè¾“å‡ºåŒº</button>
            </div>

            <div class="checkrow">
              <input type="checkbox" id="autoClearBeforeRun" checked>
              <span>è¿è¡Œå‰æ¸…ç©ºè¾“å‡ºåŒºï¼ˆä»…æ¸…ç©ºè¾“å‡ºï¼Œä¸å½±å“å½“å‰æ¨¡å‹ï¼‰</span>
            </div>
            <div class="hint">
              è§„åˆ™ï¼šä¸æ‹–å…¥æ–°æ¨¡å‹æ—¶å¯ç»§ç»­ä½¿ç”¨æ—§æ¨¡å‹ï¼›æ‹–å…¥æ–°æ¨¡å‹åï¼Œä¼šåœ¨æ–°æ¨¡å‹å†™å…¥æˆåŠŸåå†æ›¿æ¢å¹¶åˆ é™¤æ—§æ¨¡å‹ã€‚
            </div>
          </div>

          <div class="section">
            <div class="h2">
              <span>inputshapeï¼ˆå¯é€‰ï¼‰</span>
              <span class="hint" style="margin:0;">æ¸…ç©ºåè¡¨ç¤ºè‡ªåŠ¨æ¨æ–­</span>
            </div>

            <div class="shape-list" id="list_inputshape"></div>

            <div class="btnbar">
              <button class="btn-ghost" type="button" id="add_inputshape">+ æ·»åŠ è¾“å…¥</button>
              <button class="btn-ghost" type="button" id="preset_yolo_inputshape">YOLO 640</button>
              <button class="btn-ghost" type="button" id="preset_two_inputs">åŒè¾“å…¥ç¤ºä¾‹</button>
              <button class="btn-secondary" type="button" id="clear_inputshape">æ¸…ç©ºï¼ˆè‡ªåŠ¨æ¨æ–­ï¼‰</button>
              <button class="btn-danger" type="button" id="reset_inputshape">é‡ç½®é»˜è®¤</button>
            </div>

            <div class="preview" id="preview_inputshape"></div>
            <div class="hint">dtypeï¼š<span class="mono">u8 / i32 / f32 / f16</span></div>
          </div>

          <div class="section">
            <div class="h2">
              <span>inputshape2ï¼ˆå¯é€‰ï¼Œç”¨äºåŠ¨æ€ç»´åº¦åˆ¤æ–­ï¼‰</span>
              <span class="hint" style="margin:0;">æ¸…ç©ºåè¡¨ç¤ºä¸è®¾ç½®</span>
            </div>

            <div class="shape-list" id="list_inputshape2"></div>

            <div class="btnbar">
              <button class="btn-ghost" type="button" id="add_inputshape2">+ æ·»åŠ è¾“å…¥</button>
              <button class="btn-ghost" type="button" id="preset_yolo_inputshape2">YOLO 320</button>
              <button class="btn-secondary" type="button" id="clear_inputshape2">æ¸…ç©º</button>
              <button class="btn-danger" type="button" id="reset_inputshape2">é‡ç½®é»˜è®¤</button>
            </div>

            <div class="preview" id="preview_inputshape2"></div>
          </div>

          <details id="advDetails">
            <summary>
              <span>é«˜çº§å‚æ•°ï¼ˆå¯é€‰ï¼‰</span>
              <span class="rightcue"><span class="toggleText">ç‚¹å‡»å±•å¼€</span> <span class="chev" aria-hidden="true"></span></span>
            </summary>
            <div class="inner">
              <div class="grid-3">
                <div>
                  <label><span>device</span></label>
                  <select id="device">
                    <option value="">ï¼ˆä¸è®¾ç½®ï¼‰</option>
                    <option value="cpu">cpu</option>
                    <option value="gpu">gpu</option>
                  </select>
                </div>
                <div>
                  <label><span>fp16</span></label>
                  <select id="fp16">
                    <option value="">ï¼ˆä¸è®¾ç½®ï¼‰</option>
                    <option value="1">1ï¼ˆå¼€å¯ï¼‰</option>
                    <option value="0">0ï¼ˆå…³é—­ï¼‰</option>
                  </select>
                </div>
                <div>
                  <label><span>optlevel</span></label>
                  <select id="optlevel">
                    <option value="">ï¼ˆä¸è®¾ç½®ï¼‰</option>
                    <option value="0">0</option>
                    <option value="1">1</option>
                    <option value="2" selected>2ï¼ˆå¸¸ç”¨ï¼‰</option>
                    <option value="3">3</option>
                  </select>
                </div>
              </div>

              <div style="margin-top:10px;">
                <label>moduleopï¼ˆé€—å·åˆ†éš”ï¼‰</label>
                <textarea id="moduleop" placeholder="ä¾‹å¦‚: models.common.Focus,models.yolo.Detect"></textarea>
              </div>

              <div style="margin-top:10px;">
                <label>é¢å¤–å‚æ•°ï¼ˆç©ºæ ¼åˆ†éš” key=valueï¼‰</label>
                <input type="text" id="extraArgs" placeholder="ä¾‹å¦‚: ncnnpy=model_ncnn.py pnnxonnx=model.pnnx.onnx">
                <div class="hint">åªåšç®€å•ç©ºæ ¼æ‹†åˆ†ï¼Œä¸æ”¯æŒå¸¦ç©ºæ ¼çš„å€¼ã€‚</div>
              </div>
            </div>
          </details>
        </div>
      </div>

      <div class="card">
        <details open id="filesDetails">
          <summary>
            <span>è¾“å‡ºæ–‡ä»¶ï¼ˆä¸‹è½½/åˆ é™¤ï¼‰</span>
            <span class="rightcue"><span class="toggleText">ç‚¹å‡»æ”¶èµ·</span> <span class="chev" aria-hidden="true" style="transform:rotate(90deg)"></span></span>
          </summary>
          <div class="inner">
            <div class="grid-2">
              <div>
                <label>æœç´¢æ–‡ä»¶åï¼ˆå¯é€‰ï¼‰</label>
                <input type="text" id="fileSearch" placeholder="ä¾‹å¦‚ï¼šncnn / param / bin / py / onnx">
              </div>
              <div>
                <label>æ‰¹é‡æ“ä½œ</label>
                <div class="btnbar" style="margin-top:0;">
                  <button class="btn-ghost" id="refreshFilesBtn" disabled>åˆ·æ–°</button>
                  <button id="downloadBtn" disabled>ä¸‹è½½æ‰€é€‰</button>
                  <button id="downloadAndDeleteBtn" disabled>ä¸‹è½½å¹¶åˆ é™¤</button>
                  <button class="btn-danger" id="deleteSelectedBtn" disabled>åˆ é™¤æ‰€é€‰</button>
                </div>
                <div class="hint" id="fileListHint">å°šæœªè¿è¡Œ</div>
              </div>
            </div>

            <div class="tablewrap" id="fileTableWrap"></div>
          </div>
        </details>

        <details open id="logDetails">
          <summary>
            <span>è¿è¡Œæ—¥å¿—</span>
            <div class="log-actions">
              <span class="hint" style="margin:0;">é‡åˆ°è½¬æ¢é—®é¢˜ï¼Ÿç‚¹â€œå¤åˆ¶æ—¥å¿—â€æ›´æ–¹ä¾¿æ’æŸ¥</span>
              <button class="copy-btn" id="copyLogBtn" type="button">å¤åˆ¶æ—¥å¿—</button>
              <span class="rightcue"><span class="toggleText">ç‚¹å‡»æ”¶èµ·</span> <span class="chev" aria-hidden="true" style="transform:rotate(90deg)"></span></span>
            </div>
          </summary>
          <div class="inner">
            <div id="console" class="console"></div>
          </div>
        </details>
      </div>
    </div>

    <div class="footer">
      <div>èµ£ICPå¤‡2025053899å·-1</div>
      <div>
        GitHubï¼š<a href="https://github.com/futz12" target="_blank" rel="noopener noreferrer">github.com/futz12</a> Â·
        QQç¾¤ï¼š<span class="mono">767178345</span>
      </div>
    </div>
  </div>

  <div class="donate-fab" id="donateFab" title="æèµ ">
    <div class="small">æèµ </div>
  </div>

  <div class="modal" id="donateModal" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true">
      <div class="modal-head">
        <div class="t">æèµ æ”¯æŒ</div>
        <button class="btn-secondary" id="donateCloseBtn" type="button" style="height:34px;padding:0 12px;border-radius:10px;">å…³é—­</button>
      </div>
      <div class="modal-body">
        <div class="qr-grid" style="margin-top:12px;">
          <div class="qr-card">
            <div class="h">å¾®ä¿¡æ”¶æ¬¾ç </div>
            <div class="qr-img"><img id="wechatImg" alt="å¾®ä¿¡æ”¶æ¬¾ç "></div>
          </div>
          <div class="qr-card">
            <div class="h">æ”¯ä»˜å®æ”¶æ¬¾ç </div>
            <div class="qr-img"><img id="alipayImg" alt="æ”¯ä»˜å®æ”¶æ¬¾ç "></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">å·²å¤åˆ¶åˆ°å‰ªè´´æ¿</div>

  <div id="dlPanel">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
      <div style="font-weight:900;">èµ„æºä¸‹è½½ä¸­</div>
      <div id="dlPct" style="font-weight:900;opacity:.9;">0%</div>
    </div>
    <div style="margin-top:8px;height:10px;background:rgba(255,255,255,.14);border-radius:999px;overflow:hidden;">
      <div id="dlBar" style="height:100%;width:0%;background:rgba(96,165,250,.95);"></div>
    </div>
    <div id="dlText" style="margin-top:8px;font-size:12px;opacity:.9;">å‡†å¤‡ä¸‹è½½ wasmâ€¦</div>
  </div>

  <!-- è½¬æ¢é®ç½© -->
  <div id="busyOverlay" aria-hidden="true">
    <div class="overlay-card">
      <div class="spinner" aria-hidden="true"></div>
      <div class="overlay-text">
        <div class="t">æ­£åœ¨è½¬æ¢æ¨¡å‹â€¦</div>
        <div class="d" id="busyDesc">pnnx æ­£åœ¨è¿è¡Œï¼Œè¯·ç¨å€™</div>
      </div>
    </div>
  </div>

  <!-- å…¨å±€æ‹–æ‹½é®ç½© -->
  <div id="dropOverlay" aria-hidden="true">
    <div class="overlay-card">
      <div class="spinner" aria-hidden="true"></div>
      <div class="overlay-text">
        <div class="t">æ¾å¼€å³å¯å¯¼å…¥æ¨¡å‹</div>
        <div class="d">æ”¯æŒ .pt / .onnxï¼ˆä¸æ”¯æŒ .pthï¼‰</div>
      </div>
    </div>
  </div>

  <script>
    const ASSET_SOURCE = "cdn";

    const CDN_PNNX_JS   = "https://mirrors.sdu.edu.cn/ncnn_modelzoo/pnnx/pnnx.js";
    const CDN_PNNX_WASM = "https://mirrors.sdu.edu.cn/ncnn_modelzoo/pnnx/pnnx.wasm";

    const ORIGIN_BASE = "./";
    const ORIGIN_PNNX_JS   = ORIGIN_BASE + "pnnx.js";
    const ORIGIN_PNNX_WASM = ORIGIN_BASE + "pnnx.wasm";

    const PNNX_JS   = (ASSET_SOURCE === "cdn") ? CDN_PNNX_JS   : ORIGIN_PNNX_JS;
    const PNNX_WASM = (ASSET_SOURCE === "cdn") ? CDN_PNNX_WASM : ORIGIN_PNNX_WASM;

    (async function ensureSW() {
      if (!("serviceWorker" in navigator)) return;
      try {
        await navigator.serviceWorker.register("./sw.js", { scope: "./" });
      } catch (e) {
        console.warn("SW æ³¨å†Œå¤±è´¥ï¼š", e);
        return;
      }
      if (!navigator.serviceWorker.controller && !sessionStorage.getItem("swReloadedOnce")) {
        navigator.serviceWorker.addEventListener("controllerchange", () => {
          if (sessionStorage.getItem("swReloadedOnce")) return;
          sessionStorage.setItem("swReloadedOnce", "1");
          location.reload();
        });
      }
    })();

    function loadScript(src) {
      return new Promise((resolve, reject) => {
        const s = document.createElement("script");
        s.src = src;
        s.crossOrigin = "anonymous";
        s.onload = () => resolve();
        s.onerror = () => reject(new Error("pnnx.js åŠ è½½å¤±è´¥: " + src));
        document.head.appendChild(s);
      });
    }

    const WECHAT_QR_SRC = "./wechat.png";
    const ALIPAY_QR_SRC = "./alipay.png";
    document.getElementById("wechatImg").src = WECHAT_QR_SRC;
    document.getElementById("alipayImg").src = ALIPAY_QR_SRC;

    const themeBtn = document.getElementById("themeBtn");
    const mediaDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)");
    function applyTheme(theme){ document.documentElement.setAttribute("data-theme", theme); }
    function getStoredTheme(){ return localStorage.getItem("theme"); }
    function autoTheme(){ applyTheme((mediaDark && mediaDark.matches) ? "dark" : "light"); }
    function initTheme(){
      const stored = getStoredTheme();
      if(stored === "light" || stored === "dark") applyTheme(stored);
      else autoTheme();
    }
    initTheme();
    function onSystemThemeChange(){
      const stored = getStoredTheme();
      if(stored !== "light" && stored !== "dark") autoTheme();
    }
    if(mediaDark && typeof mediaDark.addEventListener === "function") mediaDark.addEventListener("change", onSystemThemeChange);
    else if(mediaDark && typeof mediaDark.addListener === "function") mediaDark.addListener(onSystemThemeChange);

    themeBtn.addEventListener("click", ()=>{
      const cur = document.documentElement.getAttribute("data-theme") || "light";
      const next = cur === "dark" ? "light" : "dark";
      applyTheme(next);
      localStorage.setItem("theme", next);
    });

    // details å¤šæ€ï¼šå±•å¼€/æ”¶èµ·æ–‡æ¡ˆ
    function bindDetailsToggleText(detailsEl){
      const txt = detailsEl.querySelector(".toggleText");
      if (!txt) return;
      const update = ()=>{ txt.textContent = detailsEl.open ? "ç‚¹å‡»æ”¶èµ·" : "ç‚¹å‡»å±•å¼€"; };
      detailsEl.addEventListener("toggle", update);
      update();
    }
    ["advDetails","filesDetails","logDetails"].forEach(id=>{
      const el = document.getElementById(id);
      if (el) bindDetailsToggleText(el);
    });

    let pnnxModule = null;

    const WORK_DIR = "/work";
    const MODELS_DIR = "/models";

    // å½“å‰æ¨¡å‹ï¼šä¿ç•™æ—§æ¨¡å‹ç›´åˆ°æ–°æ¨¡å‹å†™å…¥æˆåŠŸå†æ›¿æ¢
    let currentModelPath = "";
    let currentModelName = "";

    const dotWasm = document.getElementById("dotWasm");
    const wasmStatus = document.getElementById("wasmStatus");

    const modelFileEl = document.getElementById("modelFile");
    const modelHint = document.getElementById("modelHint");

    const pickFileBtn = document.getElementById("pickFileBtn");

    const runBtn = document.getElementById("runBtn");
    const clearLogBtn = document.getElementById("clearLogBtn");
    const clearWorkBtn = document.getElementById("clearWorkBtn");

    const consoleDiv = document.getElementById("console");

    const list_inputshape = document.getElementById("list_inputshape");
    const preview_inputshape = document.getElementById("preview_inputshape");

    const list_inputshape2 = document.getElementById("list_inputshape2");
    const preview_inputshape2 = document.getElementById("preview_inputshape2");

    const fileSearch = document.getElementById("fileSearch");
    const refreshFilesBtn = document.getElementById("refreshFilesBtn");
    const downloadBtn = document.getElementById("downloadBtn");
    const downloadAndDeleteBtn = document.getElementById("downloadAndDeleteBtn");
    const deleteSelectedBtn = document.getElementById("deleteSelectedBtn");
    const fileListHint = document.getElementById("fileListHint");
    const fileTableWrap = document.getElementById("fileTableWrap");

    const donateFab = document.getElementById("donateFab");
    const donateModal = document.getElementById("donateModal");
    const donateCloseBtn = document.getElementById("donateCloseBtn");
    function openDonate(){ donateModal.classList.add("show"); donateModal.setAttribute("aria-hidden","false"); }
    function closeDonate(){ donateModal.classList.remove("show"); donateModal.setAttribute("aria-hidden","true"); }
    donateFab.addEventListener("click", openDonate);
    donateCloseBtn.addEventListener("click", closeDonate);
    donateModal.addEventListener("click", (e)=>{ if(e.target === donateModal) closeDonate(); });
    window.addEventListener("keydown",(e)=>{ if(e.key === "Escape") closeDonate(); });

    const toastEl = document.getElementById("toast");
    let toastTimer = null;
    function showToast(msg){
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=>toastEl.classList.remove("show"), 1400);
    }

    const dlPanel = document.getElementById("dlPanel");
    const dlBar = document.getElementById("dlBar");
    const dlPct = document.getElementById("dlPct");
    const dlText = document.getElementById("dlText");
    function showDlPanel(){ dlPanel.style.display = "block"; }
    function hideDlPanel(){ dlPanel.style.display = "none"; }
    function setDlProgress(pct, text){
      const p = Math.max(0, Math.min(100, pct|0));
      dlBar.style.width = p + "%";
      dlPct.textContent = p + "%";
      if (text) dlText.textContent = text;
    }

    const busyOverlay = document.getElementById("busyOverlay");
    const busyDesc = document.getElementById("busyDesc");
    function showBusy(desc){
      busyDesc.textContent = desc || "pnnx æ­£åœ¨è¿è¡Œï¼Œè¯·ç¨å€™";
      busyOverlay.style.display = "flex";
      busyOverlay.setAttribute("aria-hidden","false");
    }
    function hideBusy(){
      busyOverlay.style.display = "none";
      busyOverlay.setAttribute("aria-hidden","true");
    }
    async function nextPaint(){
      await new Promise(r => requestAnimationFrame(()=> r()));
      await new Promise(r => requestAnimationFrame(()=> r()));
    }

    const dropOverlay = document.getElementById("dropOverlay");
    let dragDepth = 0;
    function showDropOverlay(){
      dropOverlay.style.display = "flex";
      dropOverlay.setAttribute("aria-hidden","false");
    }
    function hideDropOverlay(){
      dropOverlay.style.display = "none";
      dropOverlay.setAttribute("aria-hidden","true");
    }
    function hasFileDrag(e){
      const dt = e.dataTransfer;
      if (!dt) return false;
      return Array.from(dt.types || []).includes("Files");
    }

    const LOG_MAX_LINES = 1500;
    let logLines = [];
    function log(text) {
      const line = text.endsWith("\n") ? text.slice(0,-1) : text;
      logLines.push(line);
      if (logLines.length > LOG_MAX_LINES) logLines = logLines.slice(-LOG_MAX_LINES);
      consoleDiv.textContent = logLines.join("\n") + "\n";
      consoleDiv.scrollTop = consoleDiv.scrollHeight;
      console.log(text);
    }
    function humanBytes(bytes){
      const units=["B","KB","MB","GB"];
      let b=bytes, i=0;
      while(b>=1024 && i<units.length-1){ b/=1024; i++; }
      return `${b.toFixed(i===0?0:2)} ${units[i]}`;
    }

    async function fetchWithProgress(url, label="ä¸‹è½½") {
      showDlPanel();
      setDlProgress(0, `${label}ï¼šè¿æ¥ä¸­â€¦`);

      const resp = await fetch(url, { cache: "no-store" });
      if (!resp.ok) throw new Error(`${label}å¤±è´¥ï¼šHTTP ${resp.status}`);

      const total = Number(resp.headers.get("content-length") || "0");
      const reader = resp.body?.getReader();

      if (!reader) {
        const buf = await resp.arrayBuffer();
        setDlProgress(100, `${label}ï¼šå®Œæˆï¼ˆæœªçŸ¥å¤§å°ï¼‰`);
        setTimeout(hideDlPanel, 600);
        return new Uint8Array(buf);
      }

      let received = 0;
      const chunks = [];

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        chunks.push(value);
        received += value.byteLength;

        if (total > 0) {
          const pct = Math.round(received * 100 / total);
          setDlProgress(pct, `${label}ï¼š${humanBytes(received)} / ${humanBytes(total)}`);
        } else {
          const pct = Math.min(99, Math.round(received / 500000));
          setDlProgress(pct, `${label}ï¼šå·²ä¸‹è½½ ${humanBytes(received)}`);
        }
      }

      const out = new Uint8Array(received);
      let off = 0;
      for (const c of chunks) { out.set(c, off); off += c.byteLength; }

      setDlProgress(100, `${label}ï¼šå®Œæˆ`);
      setTimeout(hideDlPanel, 600);
      return out;
    }

    const copyLogBtn = document.getElementById("copyLogBtn");
    async function copyText(text){
      if (navigator.clipboard && navigator.clipboard.writeText) {
        await navigator.clipboard.writeText(text);
        return;
      }
      const ta = document.createElement("textarea");
      ta.value = text;
      ta.style.position = "fixed";
      ta.style.left = "-9999px";
      ta.style.top = "0";
      document.body.appendChild(ta);
      ta.focus();
      ta.select();
      document.execCommand("copy");
      document.body.removeChild(ta);
    }
    copyLogBtn.addEventListener("click", async (e)=>{
      e.preventDefault();
      e.stopPropagation();
      const text = (consoleDiv.textContent || "").trim();
      if (!text) return showToast("æ—¥å¿—ä¸ºç©ºï¼Œæš‚æ— å¯å¤åˆ¶å†…å®¹");
      try{
        await copyText(text);
        showToast("âœ… å·²å¤åˆ¶æ—¥å¿—åˆ°å‰ªè´´æ¿");
      }catch(err){
        showToast("âŒ å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©å¤åˆ¶");
      }
    });

    function isSupportedModelFile(file) {
      const name = (file?.name || "").toLowerCase();
      if (name.endsWith(".pth")) return false;
      return name.endsWith(".pt") || name.endsWith(".onnx");
    }

    function ensureDir(path) {
      try { pnnxModule.FS.mkdir(path); } catch(e) {}
    }
    function ensureWorkDir() {
      ensureDir(WORK_DIR);
      ensureDir(MODELS_DIR);
      try { pnnxModule.FS.chdir(WORK_DIR); } catch(e) {}
    }

    async function writeFileToFS(file, targetPath) {
      const buf = await file.arrayBuffer();
      pnnxModule.FS.writeFile(targetPath, new Uint8Array(buf));
    }

    function listFiles(dir) {
      ensureDir(dir);
      const names = pnnxModule.FS.readdir(dir).filter(n => n !== "." && n !== "..");
      const out = [];
      for (const name of names) {
        const full = `${dir}/${name}`;
        try {
          const st = pnnxModule.FS.stat(full);
          if (pnnxModule.FS.isFile(st.mode)) out.push({ name, full, size: st.size, dir });
        } catch(e) {}
      }
      out.sort((a,b)=>a.name.localeCompare(b.name));
      return out;
    }

    function deleteAllInDir(dir) {
      for (const f of listFiles(dir)) {
        try { pnnxModule.FS.unlink(f.full); } catch(e) {}
      }
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
    }
    function fileBadge(name){
      const n = name.toLowerCase();
      let t = "file";
      if (n.endsWith(".param")) t = "param";
      else if (n.endsWith(".bin")) t = "bin";
      else if (n.endsWith(".py")) t = "py";
      else if (n.endsWith(".onnx")) t = "onnx";
      else if (n.endsWith(".pt")) t = "pt";
      return `<span style="
        display:inline-flex;align-items:center;
        padding:2px 8px;border-radius:999px;
        border:1px solid var(--line);
        background: rgba(148,163,184,.14);
        color: var(--muted);
        font-size:12px;font-weight:900;
        margin-right:8px;
      ">${t}</span>`;
    }

    // ä»…é»˜è®¤å‹¾é€‰ .ncnn.bin / .ncnn.param
    function defaultCheckedFor(name){
      const n = name.toLowerCase();
      return n.endsWith(".ncnn.bin") || n.endsWith(".ncnn.param");
    }

    // æ›¿æ¢å½“å‰æ¨¡å‹ï¼šå…ˆå†™ä¸´æ—¶ï¼Œå†æˆåŠŸåæ›¿æ¢æ—§æ¨¡å‹
    async function replaceCurrentModelWithFile(file){
      if (!pnnxModule) {
        modelHint.textContent = `å·²é€‰æ‹©ï¼š${file.name} Â· ${humanBytes(file.size)}ï¼ˆWASM æœªå°±ç»ªï¼‰`;
        return;
      }
      ensureWorkDir();

      // ä¸´æ—¶è·¯å¾„ï¼ˆç¡®ä¿æ–°æ¨¡å‹å†™å…¥æˆåŠŸå‰æ—§æ¨¡å‹å¯ç»§ç»­ç”¨ï¼‰
      const ext = file.name.toLowerCase().endsWith(".onnx") ? "onnx" : "pt";
      const incomingName = `__incoming__${Date.now()}.${ext}`;
      const incomingPath = `${MODELS_DIR}/${incomingName}`;

      log(`ğŸ“¦ å†™å…¥æ–°æ¨¡å‹(ä¸´æ—¶): ${file.name} -> ${incomingPath}`);
      await writeFileToFS(file, incomingPath);
      log(`âœ… æ–°æ¨¡å‹å†™å…¥å®Œæˆ(ä¸´æ—¶): ${file.name}`);

      // æ–°æ¨¡å‹å†™å…¥æˆåŠŸåå†æ›¿æ¢æ—§æ¨¡å‹
      const finalPath = `${MODELS_DIR}/${file.name}`;

      if (currentModelPath && currentModelPath !== finalPath) {
        try { pnnxModule.FS.unlink(currentModelPath); log(`ğŸ§¹ å·²åˆ é™¤æ—§æ¨¡å‹: ${currentModelName}`); } catch(e) {}
      }

      // è‹¥ finalPath å·²å­˜åœ¨ï¼ˆæ¯”å¦‚åŒåé‡å¤å¯¼å…¥ï¼‰ï¼Œå…ˆåˆ 
      try { pnnxModule.FS.unlink(finalPath); } catch(e) {}

      try {
        pnnxModule.FS.rename(incomingPath, finalPath);
      } catch (e) {
        // rename å¤±è´¥å°±å¤åˆ¶+åˆ ä¸´æ—¶
        const bytes = pnnxModule.FS.readFile(incomingPath);
        pnnxModule.FS.writeFile(finalPath, bytes);
        try { pnnxModule.FS.unlink(incomingPath); } catch(_) {}
      }

      currentModelPath = finalPath;
      currentModelName = file.name;

      modelHint.textContent = `å½“å‰æ¨¡å‹ï¼š${file.name} Â· ${humanBytes(file.size)}ï¼ˆå¯é‡å¤è½¬æ¢ï¼‰`;

      // æ¸…ç©º inputï¼šç¡®ä¿â€œæ²¡æ‹–æ–°æ¨¡å‹ä¹Ÿèƒ½ç»§ç»­ç”¨æ—§æ¨¡å‹â€
      try { modelFileEl.value = ""; } catch(e) {}

      refreshFileListUI();
    }

    async function onPickOrDropFile(file){
      if (!file) return;
      if (!isSupportedModelFile(file)) {
        alert("åªæ”¯æŒ TorchScript .pt æˆ– .onnxï¼ˆä¸æ”¯æŒ .pthï¼‰ã€‚");
        return;
      }
      modelHint.textContent = `å·²é€‰æ‹©ï¼š${file.name} Â· ${humanBytes(file.size)}ï¼ˆæ­£åœ¨å†™å…¥â€¦ï¼‰`;
      await replaceCurrentModelWithFile(file);
    }

    pickFileBtn.addEventListener("click", () => modelFileEl.click());
    modelFileEl.addEventListener("change", async () => {
      const f = modelFileEl.files && modelFileEl.files[0];
      if (!f) return;
      await onPickOrDropFile(f);
    });

    // å…¨å±€æ‹–æ‹½ï¼šæ•´ä¸ªç½‘é¡µå¯æ‹–å…¥ + å…¨å±€é®ç½©æç¤º
    window.addEventListener("dragenter", (e)=>{
      if (!hasFileDrag(e)) return;
      dragDepth++;
      showDropOverlay();
      e.preventDefault();
    });
    window.addEventListener("dragover", (e)=>{
      if (!hasFileDrag(e)) return;
      e.preventDefault();
      showDropOverlay();
    });
    window.addEventListener("dragleave", (e)=>{
      if (!hasFileDrag(e)) return;
      dragDepth = Math.max(0, dragDepth - 1);
      if (dragDepth === 0) hideDropOverlay();
    });
    window.addEventListener("drop", async (e)=>{
      if (!hasFileDrag(e)) return;
      e.preventDefault();
      dragDepth = 0;
      hideDropOverlay();
      const f = e.dataTransfer?.files?.[0];
      if (f) await onPickOrDropFile(f);
    });

    // Shapes
    function addShapeRow(listEl, dims="1,3,224,224", dtype="f32") {
      const row = document.createElement("div");
      row.className = "shape-row";
      row.innerHTML = `
        <div>
          <label>ç»´åº¦ï¼ˆé€—å·åˆ†éš”ï¼‰</label>
          <input class="dims" type="text" value="${dims}" placeholder="ä¾‹å¦‚ï¼š1,3,640,640 æˆ– [1,3,640,640]">
        </div>
        <div>
          <label><span>dtype</span></label>
          <select class="dtype">
            <option value="u8">u8</option>
            <option value="i32">i32</option>
            <option value="f16">f16</option>
            <option value="f32" selected>f32</option>
          </select>
        </div>
        <div class="del">
          <button class="btn-danger" type="button" style="width:100%;">åˆ é™¤</button>
        </div>
      `;
      const dtypeSel = row.querySelector(".dtype");
      dtypeSel.value = (["u8","i32","f16","f32"].includes(dtype)) ? dtype : "f32";

      row.querySelector("button").addEventListener("click", () => {
        row.remove();
        updateShapePreview();
      });
      row.querySelector(".dims").addEventListener("input", updateShapePreview);
      dtypeSel.addEventListener("change", updateShapePreview);

      listEl.appendChild(row);
      updateShapePreview();
    }

    function normalizeShapeToken(dimsText, dtype) {
      let t = (dimsText || "").trim().replace(/\s+/g,"");
      if (!t) return "";
      const m = t.match(/^(.*?)(u8|i32|f16|f32)$/);
      if (m) { t = m[1]; dtype = m[2]; }
      if (!t.startsWith("[")) t = "[" + t;
      if (!t.endsWith("]")) t = t + "]";
      return t + (dtype || "");
    }

    function buildShapeValue(listEl) {
      const rows = Array.from(listEl.querySelectorAll(".shape-row"));
      const tokens = [];
      for (const r of rows) {
        const dims = r.querySelector(".dims").value;
        const dtype = r.querySelector(".dtype").value;
        const token = normalizeShapeToken(dims, dtype);
        if (token) tokens.push(token);
      }
      if (!tokens.length) return "";
      if (tokens.length === 1) return tokens[0];
      return `[${tokens.join(",")}]`;
    }

    function updateShapePreviewFor(listEl, previewEl, emptyText) {
      const v = buildShapeValue(listEl);
      previewEl.textContent = v ? v : emptyText;
    }

    function updateShapePreview() {
      updateShapePreviewFor(list_inputshape, preview_inputshape, "ï¼ˆæœªè®¾ç½® inputshapeï¼šå°†ä½¿ç”¨è‡ªåŠ¨æ¨æ–­ï¼‰");
      updateShapePreviewFor(list_inputshape2, preview_inputshape2, "ï¼ˆæœªè®¾ç½® inputshape2ï¼šå°†ä¸ä¼ å…¥è¯¥å‚æ•°ï¼‰");
    }

    document.getElementById("add_inputshape").addEventListener("click", () => addShapeRow(list_inputshape, "1,3,224,224", "f32"));
    document.getElementById("reset_inputshape").addEventListener("click", () => {
      list_inputshape.innerHTML = "";
      addShapeRow(list_inputshape, "1,3,224,224", "f32");
    });
    document.getElementById("clear_inputshape").addEventListener("click", () => {
      list_inputshape.innerHTML = "";
      updateShapePreview();
    });
    document.getElementById("preset_yolo_inputshape").addEventListener("click", () => {
      list_inputshape.innerHTML = "";
      addShapeRow(list_inputshape, "1,3,640,640", "f32");
    });
    document.getElementById("preset_two_inputs").addEventListener("click", () => {
      list_inputshape.innerHTML = "";
      addShapeRow(list_inputshape, "1,3,640,640", "f32");
      addShapeRow(list_inputshape, "1,160", "f32");
    });

    document.getElementById("add_inputshape2").addEventListener("click", () => addShapeRow(list_inputshape2, "1,3,320,320", "f32"));
    document.getElementById("reset_inputshape2").addEventListener("click", () => {
      list_inputshape2.innerHTML = "";
      addShapeRow(list_inputshape2, "1,3,320,320", "f32");
    });
    document.getElementById("clear_inputshape2").addEventListener("click", () => {
      list_inputshape2.innerHTML = "";
      updateShapePreview();
    });
    document.getElementById("preset_yolo_inputshape2").addEventListener("click", () => {
      list_inputshape2.innerHTML = "";
      addShapeRow(list_inputshape2, "1,3,320,320", "f32");
    });

    addShapeRow(list_inputshape, "1,3,224,224", "f32");
    list_inputshape2.innerHTML = "";
    updateShapePreview();

    // Args
    function buildArgs(modelPath) {
      const args = [modelPath];

      const shapeVal = buildShapeValue(list_inputshape);
      if (shapeVal) args.push(`inputshape=${shapeVal}`);

      const shapeVal2 = buildShapeValue(list_inputshape2);
      if (shapeVal2) args.push(`inputshape2=${shapeVal2}`);

      const device = document.getElementById("device").value.trim();
      const fp16 = document.getElementById("fp16").value.trim();
      const optlevel = document.getElementById("optlevel").value.trim();
      const moduleop = document.getElementById("moduleop").value.trim();
      const extraArgs = document.getElementById("extraArgs").value.trim();

      if (device) args.push(`device=${device}`);
      if (fp16) args.push(`fp16=${fp16}`);
      if (optlevel) args.push(`optlevel=${optlevel}`);
      if (moduleop) args.push(`moduleop=${moduleop}`);
      if (extraArgs) args.push(...extraArgs.split(/\s+/).filter(Boolean));

      return args;
    }

    // Files UI
    let cachedFiles = [];
    function renderFileTable() {
      const q = (fileSearch.value || "").trim().toLowerCase();
      const files = cachedFiles.filter(f => !q || f.name.toLowerCase().includes(q));

      if (!files.length) {
        fileTableWrap.innerHTML = `<div class="hint" style="padding:10px 12px;">ï¼ˆæ— æ–‡ä»¶ï¼‰</div>`;
        return;
      }

      const rows = files.map(f => {
        const checked = defaultCheckedFor(f.name) ? "checked" : "";
        return `
          <tr>
            <td style="width:36px;"><input class="fileCheck" type="checkbox" ${checked} data-full="${f.full}"></td>
            <td class="mono">
              ${fileBadge(f.name)}
              ${escapeHtml(f.name)}
              ${f.dir === MODELS_DIR ? `<span style="margin-left:8px;color:var(--muted);font-weight:900;font-size:12px;">(æ¨¡å‹)</span>` : ``}
            </td>
            <td class="right" style="color:var(--muted)">${escapeHtml(humanBytes(f.size))}</td>
            <td style="width:190px;">
              <div style="display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap;">
                <button class="copy-btn" type="button" data-act="dl" data-full="${f.full}">ä¸‹è½½</button>
                <button class="copy-btn" type="button" data-act="rm" data-full="${f.full}">åˆ é™¤</button>
              </div>
            </td>
          </tr>
        `;
      }).join("");

      fileTableWrap.innerHTML = `
        <table>
          <thead>
            <tr>
              <th style="width:36px;"><input id="checkAll" type="checkbox"></th>
              <th>æ–‡ä»¶å</th>
              <th class="right">å¤§å°</th>
              <th class="right">å•æ–‡ä»¶æ“ä½œ</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      `;

      const checkAll = document.getElementById("checkAll");
      checkAll.addEventListener("change", ()=>{
        document.querySelectorAll("input.fileCheck").forEach(c => c.checked = checkAll.checked);
      });

      fileTableWrap.querySelectorAll("button[data-act]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const act = btn.getAttribute("data-act");
          const full = btn.getAttribute("data-full");
          const name = full.split("/").pop();

          if (act === "dl") {
            try{
              const content = pnnxModule.FS.readFile(full);
              triggerDownload(content, name);
              log(`â¬‡ï¸ ä¸‹è½½: ${name} (${content.length} bytes)`);
            }catch(e){
              log(`âŒ ä¸‹è½½å¤±è´¥: ${name} -> ${e}`);
            }
          } else if (act === "rm") {
            if (!confirm(`ç¡®å®šåˆ é™¤ ${name} å—ï¼Ÿ`)) return;
            try{ pnnxModule.FS.unlink(full); }catch(e){}
            log(`ğŸ§¹ å·²åˆ é™¤: ${name}`);

            if (full === currentModelPath) {
              currentModelPath = "";
              currentModelName = "";
              modelHint.textContent = "å½“å‰æ¨¡å‹ï¼šæ— ";
            }

            refreshFileListUI();
          }
        });
      });
    }

    function refreshFileListUI() {
      const work = listFiles(WORK_DIR);
      const models = listFiles(MODELS_DIR);
      cachedFiles = [...models, ...work];

      fileListHint.textContent = cachedFiles.length
        ? `å…± ${cachedFiles.length} ä¸ªæ–‡ä»¶ï¼ˆæ¨¡å‹ ${models.length} / è¾“å‡º ${work.length}ï¼‰`
        : "å·¥ä½œåŒºä¸ºç©º";

      renderFileTable();

      const has = cachedFiles.length > 0;
      refreshFilesBtn.disabled = false;
      downloadBtn.disabled = !has;
      downloadAndDeleteBtn.disabled = !has;
      deleteSelectedBtn.disabled = !has;
      clearWorkBtn.disabled = false;
    }

    fileSearch.addEventListener("input", renderFileTable);

    function getSelectedFiles() {
      return Array.from(document.querySelectorAll("input.fileCheck"))
        .filter(c => c.checked)
        .map(c => c.getAttribute("data-full"));
    }

    function triggerDownload(uint8Array, filename) {
      const blob = new Blob([uint8Array], { type: "application/octet-stream" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    async function downloadSelected({ deleteAfter=false } = {}) {
      const selected = getSelectedFiles();
      if (!selected.length) { alert("è¯·å…ˆå‹¾é€‰è‡³å°‘ä¸€ä¸ªæ–‡ä»¶ã€‚"); return; }

      for (const full of selected) {
        const name = full.split("/").pop();
        try {
          const content = pnnxModule.FS.readFile(full);
          log(`â¬‡ï¸ ä¸‹è½½: ${name} (${content.length} bytes)`);
          triggerDownload(content, name);
          if (deleteAfter) {
            try { pnnxModule.FS.unlink(full); } catch(e) {}
            log(`ğŸ§¹ å·²åˆ é™¤: ${name}`);
          }
        } catch (e) {
          log(`âŒ ä¸‹è½½å¤±è´¥: ${name} -> ${e}`);
        }
        await new Promise(r => setTimeout(r, 30));
      }
      refreshFileListUI();
    }

    refreshFilesBtn.addEventListener("click", refreshFileListUI);
    downloadBtn.addEventListener("click", () => downloadSelected({ deleteAfter:false }));
    downloadAndDeleteBtn.addEventListener("click", () => downloadSelected({ deleteAfter:true }));
    deleteSelectedBtn.addEventListener("click", () => {
      const selected = getSelectedFiles();
      if (!selected.length) return alert("è¯·å…ˆå‹¾é€‰è‡³å°‘ä¸€ä¸ªæ–‡ä»¶ã€‚");
      if (!confirm(`ç¡®å®šåˆ é™¤æ‰€é€‰ ${selected.length} ä¸ªæ–‡ä»¶å—ï¼Ÿ`)) return;
      for (const full of selected) {
        const name = full.split("/").pop();
        try { pnnxModule.FS.unlink(full); } catch(e) {}
        log(`ğŸ§¹ å·²åˆ é™¤: ${name}`);
        if (full === currentModelPath) {
          currentModelPath = "";
          currentModelName = "";
          modelHint.textContent = "å½“å‰æ¨¡å‹ï¼šæ— ";
        }
      }
      refreshFileListUI();
    });

    clearLogBtn.addEventListener("click", () => { logLines = []; consoleDiv.textContent = ""; });

    clearWorkBtn.addEventListener("click", () => {
      if (!confirm("ç¡®å®šæ¸…ç©ºè¾“å‡ºåŒºå—ï¼Ÿè¿™ä¼šåˆ é™¤æ‰€æœ‰è¾“å‡ºæ–‡ä»¶ï¼ˆä¸å½±å“å½“å‰æ¨¡å‹ï¼‰ã€‚")) return;
      deleteAllInDir(WORK_DIR);
      log("ğŸ§¹ å·²æ¸…ç©ºè¾“å‡ºåŒº");
      refreshFileListUI();
    });

    // Run
    runBtn.addEventListener("click", async () => {
      if (!pnnxModule) return alert("WASM è¿˜æœªåŠ è½½å®Œæˆã€‚");
      if (!currentModelPath) return alert("è¯·å…ˆæ‹–å…¥æˆ–é€‰æ‹©ä¸€ä¸ªæ¨¡å‹æ–‡ä»¶ï¼ˆ.pt / .onnxï¼‰ã€‚");

      runBtn.disabled = true;
      runBtn.textContent = "è½¬æ¢ä¸­â€¦";
      log("\n--- å¼€å§‹æ–°ä»»åŠ¡ ---");

      try {
        ensureWorkDir();

        if (document.getElementById("autoClearBeforeRun").checked) {
          deleteAllInDir(WORK_DIR);
          log("ğŸ§¹ å·²æ¸…ç©ºè¾“å‡ºåŒºï¼ˆworkï¼‰");
        }

        const args = buildArgs(currentModelPath);
        log(`ğŸ§¾ æ‰§è¡Œï¼špnnx ${args.join(" ")}`);

        showBusy(`æ­£åœ¨è½¬æ¢ï¼š${currentModelName || currentModelPath.split("/").pop()}`);
        await nextPaint();

        try {
          pnnxModule.callMain(args);
          log("âœ… pnnx æ‰§è¡Œç»“æŸ");
        } catch (execErr) {
          log("âŒ è¿è¡Œæ—¶é”™è¯¯: " + execErr);
          if (execErr && typeof execErr.status !== "undefined") log("é€€å‡ºç : " + execErr.status);
        }

        refreshFileListUI();
      } catch (e) {
        log("âŒ é”™è¯¯: " + e);
      } finally {
        hideBusy();
        runBtn.disabled = false;
        runBtn.textContent = "å¼€å§‹è½¬æ¢";
      }
    });

    // Boot
    (async function boot() {
      try {
        await loadScript(PNNX_JS);
      } catch (e) {
        dotWasm.classList.add("bad");
        wasmStatus.textContent = "åŠ è½½å¤±è´¥";
        log("âŒ " + e.message);
        return;
      }

      if (typeof createPnnxModule !== "function") {
        dotWasm.classList.add("bad");
        wasmStatus.textContent = "åŠ è½½å¤±è´¥";
        log("âŒ pnnx.js å·²åŠ è½½ï¼Œä½† createPnnxModule ä¸å­˜åœ¨ï¼ˆæ–‡ä»¶ä¸åŒ¹é…ï¼Ÿï¼‰");
        return;
      }

      let wasmBinary = null;
      try{
        wasmBinary = await fetchWithProgress(PNNX_WASM, "ä¸‹è½½ pnnx.wasm");
      }catch(err){
        dotWasm.classList.add("bad");
        wasmStatus.textContent = "WASM ä¸‹è½½å¤±è´¥";
        log("âŒ wasm ä¸‹è½½å¤±è´¥: " + err);
        return;
      }

      createPnnxModule({
        wasmBinary,
        print: (t)=>log(t),
        printErr: (t)=>{
          const s = String(t || "");
          if (s.includes("wasm streaming compile failed") ||
              s.includes("falling back to ArrayBuffer instantiation")) return;
          log("[STDERR] " + s);
        },
        setStatus: (t)=>{ if(t) log("[System] " + t); }
      }).then(instance => {
        pnnxModule = instance;
        ensureWorkDir();

        dotWasm.classList.add("ok");
        wasmStatus.textContent = "WASM å·²å°±ç»ª";

        runBtn.disabled = false;
        runBtn.textContent = "å¼€å§‹è½¬æ¢";
        clearLogBtn.disabled = false;
        refreshFilesBtn.disabled = false;
        clearWorkBtn.disabled = false;

        // å¦‚æœ models ç›®å½•é‡Œæœ‰æ¨¡å‹ï¼ˆå–æœ€è¿‘ä¸€ä¸ªå½“å½“å‰æ¨¡å‹ï¼‰
        const models = listFiles(MODELS_DIR);
        if (models.length) {
          // å–æŒ‰åå­—æ’åºçš„æœ€åä¸€ä¸ªå¹¶ä¸ç­‰ä»·â€œæœ€æ–°â€ï¼Œè¿™é‡Œç›´æ¥å–ç¬¬ä¸€ä¸ªä¹Ÿè¡Œï¼›
          // ä½ è¦ä¸¥æ ¼â€œæœ€æ–°â€ï¼Œå¯ç”¨æ–‡ä»¶åæ—¶é—´æˆ³ç­–ç•¥ã€‚æ­¤å¤„æŒ‰ç°çŠ¶ï¼šå–ç¬¬ä¸€ä¸ªã€‚
          const m = models[0];
          currentModelPath = m.full;
          currentModelName = m.name;
          modelHint.textContent = `å½“å‰æ¨¡å‹ï¼š${m.name} Â· ${humanBytes(m.size)}ï¼ˆå¯é‡å¤è½¬æ¢ï¼‰`;
        }

        refreshFileListUI();
        log("âœ… PNNX æ¨¡å—åŠ è½½å®Œæˆã€‚");
      }).catch(err => {
        dotWasm.classList.add("bad");
        wasmStatus.textContent = "åŠ è½½å¤±è´¥";
        log("âŒ æ¨¡å—åŠ è½½å¤±è´¥: " + err);
      });
    })();
  </script>
</body>
</html>
