<!doctype html>
<html lang="zh-CN" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PNNX åœ¨çº¿è½¬æ¢</title>
  <style>
    :root{
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;

      /* light */
      --bg:#f5f7fb;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --brand:#2563eb;
      --brand2:#1d4ed8;
      --danger:#dc2626;
      --ok:#16a34a;
      --shadow: 0 10px 24px rgba(0,0,0,.08);
      --radius:14px;

      --consoleBg:#0b1020;
      --consoleText:#b7ffb7;

      --pillBg:#fafafa;
      --panelBg:#fafafa;
      --modalMask: rgba(0,0,0,.55);

      --inputBg: #ffffff;
      --inputText: #111827;

      --controlH: 42px;
      --pad: 14px;
      --gap: 12px;

      --caret: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 24 24'%3E%3Cpath fill='%236b7280' d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
      --chev: url(\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 24 24'%3E%3Cpath fill='%236b7280' d='M9 6l6 6-6 6'/%3E%3C/svg%3E\");
    }
    html[data-theme="dark"]{
      --bg:#0b1020;
      --card:#0f172a;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --line: rgba(148,163,184,.18);
      --brand:#60a5fa;
      --brand2:#3b82f6;
      --danger:#fb7185;
      --ok:#34d399;
      --shadow: 0 12px 28px rgba(0,0,0,.35);

      --consoleBg:#050813;
      --consoleText:#a7ffb2;

      --pillBg: rgba(2,6,23,.35);
      --panelBg: rgba(2,6,23,.22);
      --modalMask: rgba(0,0,0,.65);

      --inputBg: rgba(2,6,23,.25);
      --inputText: #e5e7eb;

      --caret: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 24 24'%3E%3Cpath fill='%239ca3af' d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
      --chev: url(\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 24 24'%3E%3Cpath fill='%239ca3af' d='M9 6l6 6-6 6'/%3E%3C/svg%3E\");
    }

    html{ color-scheme: light; }
    html[data-theme="dark"]{ color-scheme: dark; }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    .wrap{ max-width: 1240px; margin: 0 auto; padding: 16px; }

    .header{
      background:var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: var(--pad);
      display:flex;
      gap: var(--gap);
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .title h1{ margin:0; font-size:18px; }
    .title p{ margin:6px 0 0; color:var(--muted); font-size:13px; line-height:1.35; }
    .status{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; color:var(--muted); font-size:12.5px; }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid var(--line);
      padding:8px 10px;
      border-radius:999px;
      background:var(--pillBg);
      backdrop-filter: blur(6px);
    }
    .dot{ width:9px; height:9px; border-radius:50%; background:#9ca3af; }
    .dot.ok{ background:var(--ok); }
    .dot.bad{ background:var(--danger); }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .body{ padding: var(--pad); }

    .main-grid{
      margin-top:12px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--gap);
      align-items:start;
    }
    @media(max-width:1050px){ .main-grid{ grid-template-columns:1fr; } }

    .section{
      border:1px solid var(--line);
      border-radius: 14px;
      background: var(--panelBg);
      padding: 12px;
    }
    .section + .section{ margin-top: 12px; }
    .h2{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 10px;
      font-weight:900;
      font-size:13px;
    }
    .hint{ margin-top:6px; color:var(--muted); font-size:12px; line-height:1.35; }
    .mono{ font-family: var(--mono); }

    .grid-2{ display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .grid-3{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
    @media(max-width:780px){ .grid-2, .grid-3{ grid-template-columns: 1fr; } }

    label{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      font-size:12px;
      color:var(--muted);
      margin: 0 0 6px;
    }

    input[type="text"], input[type="file"], select, textarea{
      width:100%;
      height: var(--controlH);
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 12px;
      outline:none;
      background: var(--inputBg);
      color: var(--inputText);
      font-size:14px;
    }
    textarea{
      height:auto;
      min-height:84px;
      resize:vertical;
    }
    select{
      appearance:none;
      -webkit-appearance:none;
      -moz-appearance:none;
      padding-right: 40px;
      background-image: var(--caret);
      background-repeat:no-repeat;
      background-position: calc(100% - 12px) 50%;
      background-size: 18px 18px;
    }
    option{ color:#111827; background:#ffffff; }
    html[data-theme="dark"] option{ color:#e5e7eb; background:#0b1220; }

    .btnbar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top: 10px;
    }
    button{
      border:0;
      background: var(--brand);
      color:#fff;
      height: var(--controlH);
      padding:0 14px;
      border-radius:12px;
      font-weight:700;
      cursor:pointer;
      font-size:13px;
    }
    button:hover{ background: var(--brand2); }
    button:disabled{ background:#94a3b8; cursor:not-allowed; }
    .btn-secondary{
      background: rgba(148,163,184,.20);
      color: var(--text);
      border:1px solid var(--line);
    }
    .btn-secondary:hover{ background: rgba(148,163,184,.30); }
    .btn-ghost{
      background: rgba(37,99,235,.10);
      color: var(--text);
      border:1px solid var(--line);
    }
    .btn-ghost:hover{ background: rgba(37,99,235,.16); }
    .btn-danger{ background: var(--danger); }
    .btn-danger:hover{ filter: brightness(.95); }

    .checkrow{
      display:flex;
      align-items:center;
      gap:10px;
      margin-top: 10px;
      color: var(--muted);
      font-size: 12.5px;
      user-select:none;
    }
    .checkrow input{ width:auto; height:auto; transform: scale(1.08); }

    .shape-list{ display:flex; flex-direction:column; gap:10px; }
    .shape-row{
      display:grid;
      grid-template-columns: 1fr 160px 92px;
      gap: 10px;
      align-items:end;
    }
    @media(max-width:780px){
      .shape-row{ grid-template-columns: 1fr 160px; }
      .shape-row .del{ grid-column: 1 / -1; }
    }
    .preview{
      margin-top:10px;
      border:1px dashed var(--line);
      border-radius:12px;
      padding:10px 12px;
      background:transparent;
      font-family: var(--mono);
      font-size:12.5px;
      color:var(--text);
      white-space:pre-wrap;
      word-break:break-all;
    }

    details{
      border:1px solid var(--line);
      border-radius: 14px;
      overflow:hidden;
      background: transparent;
      margin-top: 12px;
    }
    details summary{
      cursor:pointer;
      list-style:none;
      padding: 12px 12px;
      font-weight:900;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      user-select:none;
    }
    details summary::-webkit-details-marker{ display:none; }
    details summary .rightcue{
      display:inline-flex;
      align-items:center;
      gap:8px;
      color:var(--muted);
      font-weight:700;
      font-size:12px;
    }
    details summary .chev{
      width:18px; height:18px;
      background-image: var(--chev);
      background-size: 18px 18px;
      background-repeat:no-repeat;
      background-position:center;
      transform: rotate(0deg);
      transition: transform .15s ease;
      opacity:.9;
    }
    details[open] summary .chev{ transform: rotate(90deg); }
    details .inner{
      padding: 12px;
      border-top:1px solid var(--line);
      background: var(--panelBg);
    }

    .console{
      border:1px solid var(--line);
      border-radius:12px;
      background:var(--consoleBg);
      color:var(--consoleText);
      padding:10px 12px;
      height: 270px;
      overflow:auto;
      font-family: var(--mono);
      font-size:12.5px;
      white-space: pre-wrap;
    }

    .log-actions{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .copy-btn{
      height: 32px;
      padding: 0 10px;
      border-radius: 10px;
      font-size: 12.5px;
      font-weight: 800;
      background: rgba(148,163,184,.18);
      color: var(--text);
      border: 1px solid var(--line);
    }
    .copy-btn:hover{ background: rgba(148,163,184,.28); }
    .copy-hint{
      color: var(--muted);
      font-size: 12px;
      font-weight: 700;
      white-space:nowrap;
    }
    @media(max-width:520px){
      .copy-hint{ white-space:normal; }
    }

    .tablewrap{
      border:1px solid var(--line);
      border-radius:12px;
      overflow:hidden;
      margin-top:10px;
      background: transparent;
    }
    table{ width:100%; border-collapse:collapse; }
    th, td{
      padding:10px 10px;
      border-bottom:1px solid var(--line);
      text-align:left;
      font-size:13px;
    }
    th{ background:var(--panelBg); color:var(--muted); font-weight:900; }
    tr:last-child td{ border-bottom:none; }
    .right{ text-align:right; }

    .donate-fab{
      position:fixed;
      right: 16px;
      bottom: 16px;
      width: 56px;
      height: 56px;
      border-radius: 999px;
      background: var(--brand);
      color:#fff;
      box-shadow: var(--shadow);
      border: 1px solid rgba(255,255,255,.14);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      user-select:none;
      z-index: 1200;
      font-weight: 900;
      letter-spacing: .5px;
    }
    .donate-fab:hover{ background: var(--brand2); }
    .donate-fab:active{ transform: translateY(1px); }
    .donate-fab .small{ font-size: 12.5px; line-height: 1; }

    .modal{
      position:fixed;
      inset:0;
      background: var(--modalMask);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:2000;
      padding: 16px;
    }
    .modal.show{ display:flex; }
    .modal-card{
      width: min(860px, 100%);
      background: var(--card);
      border-radius: 16px;
      border:1px solid var(--line);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modal-head{
      padding: 12px 14px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .modal-head .t{ font-weight:900; }
    .modal-body{ padding: 14px; }
    .qr-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media(max-width:760px){ .qr-grid{ grid-template-columns:1fr; } }
    .qr-card{
      border:1px solid var(--line);
      border-radius:14px;
      padding: 12px;
      background:var(--panelBg);
    }
    .qr-card .h{ font-weight:900; margin-bottom:8px; }
    .qr-img{
      width:100%;
      aspect-ratio: 1 / 1;
      border:1px dashed var(--line);
      border-radius:12px;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      background: transparent;
    }
    .qr-img img{ width:100%; height:100%; object-fit:contain; }

    .footer{
      margin-top: 14px;
      padding: 12px 0 4px;
      color: var(--muted);
      font-size: 12.5px;
      text-align:center;
    }
    .footer a{ color: var(--brand); text-decoration:none; }
    .footer a:hover{ text-decoration:underline; }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 92px;
      transform: translateX(-50%);
      background: rgba(17,24,39,.92);
      color: #fff;
      padding: 10px 12px;
      border-radius: 12px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(255,255,255,.12);
      z-index: 2500;
      display:none;
      font-size: 12.5px;
      font-weight: 800;
    }
    html[data-theme="dark"] .toast{ background: rgba(2,6,23,.92); }
    .toast.show{ display:block; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="title">
        <h1>PNNX åœ¨çº¿è½¬æ¢</h1>
        <p>æ”¯æŒ <span class="mono">TorchScript .pt</span> å’Œ <span class="mono">.onnx</span>ï¼ˆä¸æ”¯æŒ .pthï¼‰ã€‚inputshape é»˜è®¤ç»™ä¸€è¡Œç¤ºä¾‹ï¼Œå¯æ¸…ç©ºä»£è¡¨è‡ªåŠ¨æ¨æ–­ã€‚</p>
      </div>
      <div class="status">
        <div class="pill"><span class="dot" id="dotWasm"></span><span id="wasmStatus">WASM åŠ è½½ä¸­â€¦</span></div>
        <div class="pill">
          <button id="themeBtn" class="btn-secondary" type="button" style="height:34px;padding:0 12px;border-radius:999px;">åˆ‡æ¢æ·±è‰²/æµ…è‰²</button>
        </div>
      </div>
    </div>

    <div class="main-grid">
      <!-- å·¦ï¼šå‚æ•° -->
      <div class="card">
        <div class="body">
          <div class="section">
            <div class="h2">æ¨¡å‹</div>
            <div>
              <label>æ¨¡å‹æ–‡ä»¶ï¼ˆ.pt / .onnxï¼‰</label>
              <input type="file" id="modelFile" accept=".pt,.onnx">
              <div class="hint" id="modelHint">æœªé€‰æ‹©æ¨¡å‹</div>
            </div>

            <div class="btnbar">
              <button id="runBtn" disabled>åŠ è½½ WASM ä¸­â€¦</button>
              <button class="btn-secondary" id="clearLogBtn" disabled>æ¸…ç©ºæ—¥å¿—</button>
              <button class="btn-danger" id="clearWorkBtn" disabled>æ¸…ç©ºè¾“å‡ºåŒº</button>
            </div>

            <div class="checkrow">
              <input type="checkbox" id="autoClearBeforeRun" checked>
              <span>è¿è¡Œå‰æ¸…ç©ºè¾“å‡ºåŒº</span>
            </div>
          </div>

          <div class="section">
            <div class="h2">
              <span>inputshapeï¼ˆå¯é€‰ï¼‰</span>
              <span class="hint" style="margin:0;">æ¸…ç©ºåè¡¨ç¤ºè‡ªåŠ¨æ¨æ–­</span>
            </div>

            <div class="shape-list" id="list_inputshape"></div>

            <div class="btnbar">
              <button class="btn-ghost" type="button" id="add_inputshape">+ æ·»åŠ è¾“å…¥</button>
              <button class="btn-ghost" type="button" id="preset_yolo_inputshape">YOLO 640</button>
              <button class="btn-ghost" type="button" id="preset_two_inputs">åŒè¾“å…¥ç¤ºä¾‹</button>
              <button class="btn-secondary" type="button" id="clear_inputshape">æ¸…ç©ºï¼ˆè‡ªåŠ¨æ¨æ–­ï¼‰</button>
              <button class="btn-danger" type="button" id="reset_inputshape">é‡ç½®é»˜è®¤</button>
            </div>

            <div class="preview" id="preview_inputshape"></div>
            <div class="hint">dtypeï¼š<span class="mono">f16 / f32 / i32</span>ã€‚å¤šè¾“å…¥ç¤ºä¾‹ï¼š<span class="mono">[[1,3,640,640]f32,[1,160]f32]</span></div>
          </div>

          <details>
            <summary>
              <span>é«˜çº§å‚æ•°ï¼ˆå¯é€‰ï¼‰</span>
              <span class="rightcue">ç‚¹å‡»å±•å¼€ <span class="chev" aria-hidden="true"></span></span>
            </summary>
            <div class="inner">
              <div class="grid-3">
                <div>
                  <label><span>device</span></label>
                  <select id="device">
                    <option value="">ï¼ˆä¸è®¾ç½®ï¼‰</option>
                    <option value="cpu">cpu</option>
                    <option value="gpu">gpu</option>
                  </select>
                </div>
                <div>
                  <label><span>fp16</span></label>
                  <select id="fp16">
                    <option value="">ï¼ˆä¸è®¾ç½®ï¼‰</option>
                    <option value="1">1ï¼ˆå¼€å¯ï¼‰</option>
                    <option value="0">0ï¼ˆå…³é—­ï¼‰</option>
                  </select>
                </div>
                <div>
                  <label><span>optlevel</span></label>
                  <select id="optlevel">
                    <option value="">ï¼ˆä¸è®¾ç½®ï¼‰</option>
                    <option value="0">0</option>
                    <option value="1">1</option>
                    <option value="2" selected>2ï¼ˆå¸¸ç”¨ï¼‰</option>
                    <option value="3">3</option>
                  </select>
                </div>
              </div>

              <div style="margin-top:10px;">
                <label>moduleopï¼ˆé€—å·åˆ†éš”ï¼‰</label>
                <textarea id="moduleop" placeholder="ä¾‹å¦‚: models.common.Focus,models.yolo.Detect"></textarea>
              </div>

              <div style="margin-top:10px;">
                <label>é¢å¤–å‚æ•°ï¼ˆç©ºæ ¼åˆ†éš” key=valueï¼‰</label>
                <input type="text" id="extraArgs" placeholder="ä¾‹å¦‚: ncnnpy=model_ncnn.py pnnxonnx=model.pnnx.onnx">
                <div class="hint">åªåšç®€å•ç©ºæ ¼æ‹†åˆ†ï¼Œä¸æ”¯æŒå¸¦ç©ºæ ¼çš„å€¼ã€‚</div>
              </div>
            </div>
          </details>
        </div>
      </div>

      <!-- å³ï¼šè¾“å‡º+æ—¥å¿— -->
      <div class="card">
        <details open>
          <summary>
            <span>è¾“å‡ºæ–‡ä»¶ï¼ˆä¸‹è½½/åˆ é™¤ï¼‰</span>
            <span class="rightcue">ç­›é€‰/å‹¾é€‰ <span class="chev" aria-hidden="true" style="transform:rotate(90deg)"></span></span>
          </summary>
          <div class="inner">
            <div class="grid-2">
              <div>
                <label>æœç´¢æ–‡ä»¶åï¼ˆå¯é€‰ï¼‰</label>
                <input type="text" id="fileSearch" placeholder="ä¾‹å¦‚ï¼šncnn / param / bin / py / onnx">
              </div>
              <div>
                <label>æ“ä½œ</label>
                <div class="btnbar" style="margin-top:0;">
                  <button class="btn-ghost" id="refreshFilesBtn" disabled>åˆ·æ–°</button>
                  <button id="downloadBtn" disabled>ä¸‹è½½æ‰€é€‰</button>
                  <button id="downloadAndDeleteBtn" disabled>ä¸‹è½½å¹¶åˆ é™¤</button>
                  <button class="btn-danger" id="deleteSelectedBtn" disabled>åˆ é™¤æ‰€é€‰</button>
                </div>
                <div class="hint" id="fileListHint">å°šæœªè¿è¡Œ</div>
              </div>
            </div>

            <div class="tablewrap" id="fileTableWrap"></div>
          </div>
        </details>

        <details open>
          <summary>
            <span>è¿è¡Œæ—¥å¿—</span>
            <div class="log-actions">
              <span class="copy-hint">é‡åˆ°è½¬æ¢é—®é¢˜ï¼Ÿç‚¹â€œå¤åˆ¶æ—¥å¿—â€å‘é€ç»™å¤§ä½¬ä»¬æ›´æ–¹ä¾¿æ’æŸ¥</span>
              <button class="copy-btn" id="copyLogBtn" type="button">å¤åˆ¶æ—¥å¿—</button>
              <span class="rightcue">å¯å±•å¼€/æ”¶èµ· <span class="chev" aria-hidden="true" style="transform:rotate(90deg)"></span></span>
            </div>
          </summary>
          <div class="inner">
            <div id="console" class="console"></div>
          </div>
        </details>
      </div>
    </div>

    <div class="footer">
      <div>èµ£ICPå¤‡2025053899å·-1</div>
      <div>
        GitHubï¼š<a href="https://github.com/futz12" target="_blank" rel="noopener noreferrer">github.com/futz12</a> Â·
        QQç¾¤ï¼š<span class="mono">767178345</span>
      </div>
    </div>
  </div>

  <!-- å³ä¸‹è§’åœ†å½¢æèµ æŒ‰é’® -->
  <div class="donate-fab" id="donateFab" title="æèµ ">
    <div class="small">æèµ </div>
  </div>

  <!-- æèµ å¼¹çª—ï¼ˆæ”¶æ¬¾ç ç¡¬ç¼–ç ï¼‰ -->
  <div class="modal" id="donateModal" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true">
      <div class="modal-head">
        <div class="t">æèµ æ”¯æŒ</div>
        <button class="btn-secondary" id="donateCloseBtn" type="button" style="height:34px;padding:0 12px;border-radius:10px;">å…³é—­</button>
      </div>
      <div class="modal-body">
        <div class="qr-grid" style="margin-top:12px;">
          <div class="qr-card">
            <div class="h">å¾®ä¿¡æ”¶æ¬¾ç </div>
            <div class="qr-img"><img id="wechatImg" alt="å¾®ä¿¡æ”¶æ¬¾ç "></div>
          </div>
          <div class="qr-card">
            <div class="h">æ”¯ä»˜å®æ”¶æ¬¾ç </div>
            <div class="qr-img"><img id="alipayImg" alt="æ”¯ä»˜å®æ”¶æ¬¾ç "></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- toast -->
  <div class="toast" id="toast">å·²å¤åˆ¶åˆ°å‰ªè´´æ¿</div>

  <script>
    const ASSET_SOURCE = "origin"; // "cdn" æˆ– "origin"

    // CDN
    const CDN_PNNX_JS   = "https://mirrors.sdu.edu.cn/ncnn_modelzoo/pnnx/pnnx.js";
    const CDN_PNNX_WASM = "https://mirrors.sdu.edu.cn/ncnn_modelzoo/pnnx/pnnx.wasm";

    // æºç«™ï¼ˆåŒæºï¼‰ï¼šé»˜è®¤åŒç›®å½• ./pnnx.js ./pnnx.wasm
    // å¦‚æœä½ æºç«™åœ¨åˆ«çš„è·¯å¾„ï¼ŒæŠŠ ORIGIN_BASE æ”¹æˆä¾‹å¦‚ï¼š"/ncnn_modelzoo/pnnx/"
    const ORIGIN_BASE = "./";
    const ORIGIN_PNNX_JS   = ORIGIN_BASE + "pnnx.js";
    const ORIGIN_PNNX_WASM = ORIGIN_BASE + "pnnx.wasm";

    const PNNX_JS   = (ASSET_SOURCE === "cdn") ? CDN_PNNX_JS   : ORIGIN_PNNX_JS;
    const PNNX_WASM = (ASSET_SOURCE === "cdn") ? CDN_PNNX_WASM : ORIGIN_PNNX_WASM;

    // Service Workerï¼šå¼ºç¼“å­˜ wasmï¼ˆå‘½ä¸­ç¼“å­˜å°±ä¸è”ç½‘ï¼‰
    (async function ensureSW() {
      if (!("serviceWorker" in navigator)) return;
      try {
        await navigator.serviceWorker.register("./sw.js", { scope: "./" });
      } catch (e) {
        console.warn("SW æ³¨å†Œå¤±è´¥ï¼š", e);
        return;
      }

      // è‹¥é¦–æ¬¡åŠ è½½è¿˜æ²¡è¢« SW æ¥ç®¡ï¼Œè‡ªåŠ¨åˆ·æ–°ä¸€æ¬¡è®©å®ƒæ¥ç®¡ï¼ˆåªåˆ·æ–°ä¸€æ¬¡ï¼‰
      if (!navigator.serviceWorker.controller && !sessionStorage.getItem("swReloadedOnce")) {
        navigator.serviceWorker.addEventListener("controllerchange", () => {
          if (sessionStorage.getItem("swReloadedOnce")) return;
          sessionStorage.setItem("swReloadedOnce", "1");
          location.reload();
        });
      }
    })();

    // é™é»˜å¤„ç† streaming MIME é”™è¯¯ï¼šä¸å†å‡ºç°é‚£ä¸¤è¡Œ
    (function patchInstantiateStreaming() {
      if (!WebAssembly.instantiateStreaming) return;
      const orig = WebAssembly.instantiateStreaming.bind(WebAssembly);
      WebAssembly.instantiateStreaming = async (source, importObject) => {
        const resp = await source;
        try {
          return await orig(resp, importObject);
        } catch (e) {
          const bytes = await resp.arrayBuffer();
          return await WebAssembly.instantiate(bytes, importObject);
        }
      };
    })();

    // åŠ¨æ€åŠ è½½ pnnx.jsï¼ˆæŒ‰ ASSET_SOURCE é€‰æ‹©ï¼‰
    function loadScript(src) {
      return new Promise((resolve, reject) => {
        const s = document.createElement("script");
        s.src = src;
        s.crossOrigin = "anonymous";
        s.onload = () => resolve();
        s.onerror = () => reject(new Error("pnnx.js åŠ è½½å¤±è´¥: " + src));
        document.head.appendChild(s);
      });
    }

    // æ”¶æ¬¾ç ç¡¬ç¼–ç 
    const WECHAT_QR_SRC = "./wechat.png";
    const ALIPAY_QR_SRC = "./alipay.png";
    document.getElementById("wechatImg").src = WECHAT_QR_SRC;
    document.getElementById("alipayImg").src = ALIPAY_QR_SRC;

    // Theme: auto detect + manual override
    const themeBtn = document.getElementById("themeBtn");
    const mediaDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)");
    function applyTheme(theme){ document.documentElement.setAttribute("data-theme", theme); }
    function getStoredTheme(){ return localStorage.getItem("theme"); }
    function autoTheme(){ applyTheme((mediaDark && mediaDark.matches) ? "dark" : "light"); }
    function initTheme(){
      const stored = getStoredTheme();
      if(stored === "light" || stored === "dark") applyTheme(stored);
      else autoTheme();
    }
    initTheme();
    function onSystemThemeChange(){
      const stored = getStoredTheme();
      if(stored !== "light" && stored !== "dark") autoTheme();
    }
    if(mediaDark && typeof mediaDark.addEventListener === "function") mediaDark.addEventListener("change", onSystemThemeChange);
    else if(mediaDark && typeof mediaDark.addListener === "function") mediaDark.addListener(onSystemThemeChange);

    themeBtn.addEventListener("click", ()=>{
      const cur = document.documentElement.getAttribute("data-theme") || "light";
      const next = cur === "dark" ? "light" : "dark";
      applyTheme(next);
      localStorage.setItem("theme", next);
    });

    // Core
    let pnnxModule = null;
    const WORK_DIR = "/work";

    const dotWasm = document.getElementById("dotWasm");
    const wasmStatus = document.getElementById("wasmStatus");

    const modelFileEl = document.getElementById("modelFile");
    const modelHint = document.getElementById("modelHint");

    const runBtn = document.getElementById("runBtn");
    const clearLogBtn = document.getElementById("clearLogBtn");
    const clearWorkBtn = document.getElementById("clearWorkBtn");

    const consoleDiv = document.getElementById("console");
    const list_inputshape = document.getElementById("list_inputshape");
    const preview_inputshape = document.getElementById("preview_inputshape");

    const fileSearch = document.getElementById("fileSearch");
    const refreshFilesBtn = document.getElementById("refreshFilesBtn");
    const downloadBtn = document.getElementById("downloadBtn");
    const downloadAndDeleteBtn = document.getElementById("downloadAndDeleteBtn");
    const deleteSelectedBtn = document.getElementById("deleteSelectedBtn");
    const fileListHint = document.getElementById("fileListHint");
    const fileTableWrap = document.getElementById("fileTableWrap");

    // Donate modal
    const donateFab = document.getElementById("donateFab");
    const donateModal = document.getElementById("donateModal");
    const donateCloseBtn = document.getElementById("donateCloseBtn");
    function openDonate(){ donateModal.classList.add("show"); donateModal.setAttribute("aria-hidden","false"); }
    function closeDonate(){ donateModal.classList.remove("show"); donateModal.setAttribute("aria-hidden","true"); }
    donateFab.addEventListener("click", openDonate);
    donateCloseBtn.addEventListener("click", closeDonate);
    donateModal.addEventListener("click", (e)=>{ if(e.target === donateModal) closeDonate(); });
    window.addEventListener("keydown",(e)=>{ if(e.key === "Escape") closeDonate(); });

    // Toast
    const toastEl = document.getElementById("toast");
    let toastTimer = null;
    function showToast(msg){
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=>toastEl.classList.remove("show"), 1400);
    }

    // Logging (cap)
    const LOG_MAX_LINES = 1500;
    let logLines = [];
    function log(text) {
      const line = text.endsWith("\n") ? text.slice(0,-1) : text;
      logLines.push(line);
      if (logLines.length > LOG_MAX_LINES) logLines = logLines.slice(-LOG_MAX_LINES);
      consoleDiv.textContent = logLines.join("\n") + "\n";
      consoleDiv.scrollTop = consoleDiv.scrollHeight;
      console.log(text);
    }
    function humanBytes(bytes){
      const units=["B","KB","MB","GB"];
      let b=bytes, i=0;
      while(b>=1024 && i<units.length-1){ b/=1024; i++; }
      return `${b.toFixed(i===0?0:2)} ${units[i]}`;
    }

    // Copy log button
    const copyLogBtn = document.getElementById("copyLogBtn");
    async function copyText(text){
      if (navigator.clipboard && navigator.clipboard.writeText) {
        await navigator.clipboard.writeText(text);
        return;
      }
      const ta = document.createElement("textarea");
      ta.value = text;
      ta.style.position = "fixed";
      ta.style.left = "-9999px";
      ta.style.top = "0";
      document.body.appendChild(ta);
      ta.focus();
      ta.select();
      document.execCommand("copy");
      document.body.removeChild(ta);
    }
    copyLogBtn.addEventListener("click", async (e)=>{
      e.preventDefault();
      e.stopPropagation();
      const text = (consoleDiv.textContent || "").trim();
      if (!text) return showToast("æ—¥å¿—ä¸ºç©ºï¼Œæš‚æ— å¯å¤åˆ¶å†…å®¹");
      try{
        await copyText(text);
        showToast("âœ… å·²å¤åˆ¶æ—¥å¿—åˆ°å‰ªè´´æ¿");
      }catch(err){
        showToast("âŒ å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©å¤åˆ¶");
      }
    });

    // Guard
    function isSupportedModelFile(file) {
      const name = (file?.name || "").toLowerCase();
      if (name.endsWith(".pth")) return false;
      return name.endsWith(".pt") || name.endsWith(".onnx");
    }
    modelFileEl.addEventListener("change", () => {
      const f = modelFileEl.files && modelFileEl.files[0];
      if (!f) { modelHint.textContent = "æœªé€‰æ‹©æ¨¡å‹"; return; }
      if (!isSupportedModelFile(f)) {
        alert("åªæ”¯æŒ TorchScript .pt æˆ– .onnxï¼ˆä¸æ”¯æŒ .pthï¼‰ã€‚");
        modelFileEl.value = "";
        modelHint.textContent = "æœªé€‰æ‹©æ¨¡å‹";
        return;
      }
      modelHint.textContent = `${f.name} Â· ${humanBytes(f.size)}`;
    });

    // FS helpers
    function ensureWorkDir() {
      try { pnnxModule.FS.mkdir(WORK_DIR); } catch(e) {}
      try { pnnxModule.FS.chdir(WORK_DIR); } catch(e) {}
    }
    async function writeFileToFS(file, targetPath) {
      const buf = await file.arrayBuffer();
      pnnxModule.FS.writeFile(targetPath, new Uint8Array(buf));
    }
    function listFilesInWorkDir() {
      ensureWorkDir();
      const names = pnnxModule.FS.readdir(WORK_DIR).filter(n => n !== "." && n !== "..");
      const out = [];
      for (const name of names) {
        const full = `${WORK_DIR}/${name}`;
        try {
          const st = pnnxModule.FS.stat(full);
          if (pnnxModule.FS.isFile(st.mode)) out.push({ name, full, size: st.size });
        } catch(e) {}
      }
      out.sort((a,b)=>a.name.localeCompare(b.name));
      return out;
    }
    function deleteAllInWorkDir() {
      for (const f of listFilesInWorkDir()) {
        try { pnnxModule.FS.unlink(f.full); } catch(e) {}
      }
    }

    // Output UI
    let cachedFiles = [];
    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
    }
    function renderFileTable() {
      const q = (fileSearch.value || "").trim().toLowerCase();
      const files = cachedFiles.filter(f => !q || f.name.toLowerCase().includes(q));

      if (!files.length) {
        fileTableWrap.innerHTML = `<div class="hint" style="padding:10px 12px;">ï¼ˆæ— æ–‡ä»¶ï¼‰</div>`;
        return;
      }

      const rows = files.map(f => `
        <tr>
          <td style="width:36px;"><input class="fileCheck" type="checkbox" checked data-full="${f.full}"></td>
          <td class="mono">${escapeHtml(f.name)}</td>
          <td class="right" style="color:var(--muted)">${escapeHtml(humanBytes(f.size))}</td>
        </tr>
      `).join("");

      fileTableWrap.innerHTML = `
        <table>
          <thead><tr><th></th><th>æ–‡ä»¶å</th><th class="right">å¤§å°</th></tr></thead>
          <tbody>${rows}</tbody>
        </table>
      `;
    }
    function refreshFileListUI() {
      cachedFiles = listFilesInWorkDir();
      fileListHint.textContent = cachedFiles.length ? `å…± ${cachedFiles.length} ä¸ªæ–‡ä»¶ï¼ˆå¯å‹¾é€‰ä¸‹è½½ï¼‰` : "å·¥ä½œåŒºä¸ºç©º";
      renderFileTable();

      const has = cachedFiles.length > 0;
      refreshFilesBtn.disabled = false;
      downloadBtn.disabled = !has;
      downloadAndDeleteBtn.disabled = !has;
      deleteSelectedBtn.disabled = !has;
      clearWorkBtn.disabled = false;
    }
    fileSearch.addEventListener("input", renderFileTable);

    function getSelectedFiles() {
      return Array.from(document.querySelectorAll("input.fileCheck"))
        .filter(c => c.checked)
        .map(c => c.getAttribute("data-full"));
    }
    function triggerDownload(uint8Array, filename) {
      const blob = new Blob([uint8Array], { type: "application/octet-stream" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
    async function downloadSelected({ deleteAfter=false } = {}) {
      const selected = getSelectedFiles();
      if (!selected.length) { alert("è¯·å…ˆå‹¾é€‰è‡³å°‘ä¸€ä¸ªæ–‡ä»¶ã€‚"); return; }
      for (const full of selected) {
        const name = full.split("/").pop();
        try {
          const content = pnnxModule.FS.readFile(full);
          log(`â¬‡ï¸ ä¸‹è½½: ${name} (${content.length} bytes)`);
          triggerDownload(content, name);
          if (deleteAfter) {
            try { pnnxModule.FS.unlink(full); } catch(e) {}
            log(`ğŸ§¹ å·²åˆ é™¤: ${name}`);
          }
        } catch (e) {
          log(`âŒ ä¸‹è½½å¤±è´¥: ${name} -> ${e}`);
        }
        await new Promise(r => setTimeout(r, 30));
      }
      refreshFileListUI();
    }
    refreshFilesBtn.addEventListener("click", refreshFileListUI);
    downloadBtn.addEventListener("click", () => downloadSelected({ deleteAfter:false }));
    downloadAndDeleteBtn.addEventListener("click", () => downloadSelected({ deleteAfter:true }));
    deleteSelectedBtn.addEventListener("click", () => {
      const selected = getSelectedFiles();
      if (!selected.length) return alert("è¯·å…ˆå‹¾é€‰è‡³å°‘ä¸€ä¸ªæ–‡ä»¶ã€‚");
      if (!confirm(`ç¡®å®šåˆ é™¤æ‰€é€‰ ${selected.length} ä¸ªæ–‡ä»¶å—ï¼Ÿ`)) return;
      for (const full of selected) {
        const name = full.split("/").pop();
        try { pnnxModule.FS.unlink(full); } catch(e) {}
        log(`ğŸ§¹ å·²åˆ é™¤: ${name}`);
      }
      refreshFileListUI();
    });

    clearLogBtn.addEventListener("click", () => { logLines = []; consoleDiv.textContent = ""; });
    clearWorkBtn.addEventListener("click", () => {
      if (!confirm("ç¡®å®šæ¸…ç©ºè¾“å‡ºåŒºå—ï¼Ÿè¿™ä¼šåˆ é™¤æ‰€æœ‰è¾“å‡ºæ–‡ä»¶ã€‚")) return;
      deleteAllInWorkDir();
      log("ğŸ§¹ å·²æ¸…ç©ºè¾“å‡ºåŒº");
      refreshFileListUI();
    });

    // Shapes (optional, default has one row)
    function addShapeRow(listEl, dims="1,3,224,224", dtype="f32") {
      const row = document.createElement("div");
      row.className = "shape-row";
      row.innerHTML = `
        <div>
          <label>ç»´åº¦ï¼ˆé€—å·åˆ†éš”ï¼‰</label>
          <input class="dims" type="text" value="${dims}" placeholder="ä¾‹å¦‚ï¼š1,3,640,640 æˆ– [1,3,640,640]">
        </div>
        <div>
          <label><span>dtype</span></label>
          <select class="dtype">
            <option value="f16">f16</option>
            <option value="f32" selected>f32</option>
            <option value="i32">i32</option>
          </select>
        </div>
        <div class="del">
          <button class="btn-danger" type="button" style="width:100%;">åˆ é™¤</button>
        </div>
      `;
      const dtypeSel = row.querySelector(".dtype");
      dtypeSel.value = (dtype === "f16" || dtype === "f32" || dtype === "i32") ? dtype : "f32";

      row.querySelector("button").addEventListener("click", () => {
        row.remove();
        updateShapePreview();
      });
      row.querySelector(".dims").addEventListener("input", updateShapePreview);
      dtypeSel.addEventListener("change", updateShapePreview);

      listEl.appendChild(row);
      updateShapePreview();
    }

    function normalizeShapeToken(dimsText, dtype) {
      let t = (dimsText || "").trim().replace(/\s+/g,"");
      if (!t) return "";
      const m = t.match(/^(.*?)(f16|f32|i32)$/);
      if (m) { t = m[1]; dtype = m[2]; }
      if (!t.startsWith("[")) t = "[" + t;
      if (!t.endsWith("]")) t = t + "]";
      return t + (dtype || "");
    }

    function buildShapeValue(listEl) {
      const rows = Array.from(listEl.querySelectorAll(".shape-row"));
      const tokens = [];
      for (const r of rows) {
        const dims = r.querySelector(".dims").value;
        const dtype = r.querySelector(".dtype").value;
        const token = normalizeShapeToken(dims, dtype);
        if (token) tokens.push(token);
      }
      if (!tokens.length) return ""; // empty => auto infer
      if (tokens.length === 1) return tokens[0];
      return `[${tokens.join(",")}]`;
    }

    function updateShapePreview() {
      const v = buildShapeValue(list_inputshape);
      preview_inputshape.textContent = v ? v : "ï¼ˆæœªè®¾ç½® inputshapeï¼šå°†ä½¿ç”¨è‡ªåŠ¨æ¨æ–­ï¼‰";
    }

    document.getElementById("add_inputshape").addEventListener("click", () => addShapeRow(list_inputshape, "1,3,224,224", "f32"));
    document.getElementById("reset_inputshape").addEventListener("click", () => {
      list_inputshape.innerHTML = "";
      addShapeRow(list_inputshape, "1,3,224,224", "f32");
    });
    document.getElementById("clear_inputshape").addEventListener("click", () => {
      list_inputshape.innerHTML = "";
      updateShapePreview();
    });
    document.getElementById("preset_yolo_inputshape").addEventListener("click", () => {
      list_inputshape.innerHTML = "";
      addShapeRow(list_inputshape, "1,3,640,640", "f32");
    });
    document.getElementById("preset_two_inputs").addEventListener("click", () => {
      list_inputshape.innerHTML = "";
      addShapeRow(list_inputshape, "1,3,640,640", "f32");
      addShapeRow(list_inputshape, "1,160", "f32");
    });

    // default row
    addShapeRow(list_inputshape, "1,3,224,224", "f32");
    updateShapePreview();

    // Args builder
    function buildArgs(modelPath) {
      const args = [modelPath];

      const shapeVal = buildShapeValue(list_inputshape);
      if (shapeVal) args.push(`inputshape=${shapeVal}`);

      const device = document.getElementById("device").value.trim();
      const fp16 = document.getElementById("fp16").value.trim();
      const optlevel = document.getElementById("optlevel").value.trim();
      const moduleop = document.getElementById("moduleop").value.trim();
      const extraArgs = document.getElementById("extraArgs").value.trim();

      if (device) args.push(`device=${device}`);
      if (fp16) args.push(`fp16=${fp16}`);
      if (optlevel) args.push(`optlevel=${optlevel}`);
      if (moduleop) args.push(`moduleop=${moduleop}`);
      if (extraArgs) args.push(...extraArgs.split(/\s+/).filter(Boolean));

      return { ok:true, args };
    }

    // Run
    runBtn.addEventListener("click", async () => {
      if (!pnnxModule) return alert("WASM è¿˜æœªåŠ è½½å®Œæˆã€‚");
      const fileInput = modelFileEl;

      if (!fileInput.files || fileInput.files.length === 0) return alert("è¯·é€‰æ‹© .pt æˆ– .onnx æ–‡ä»¶ã€‚");
      const modelFile = fileInput.files[0];
      if (!isSupportedModelFile(modelFile)) return alert("åªæ”¯æŒ TorchScript .pt æˆ– .onnxï¼ˆä¸æ”¯æŒ .pthï¼‰ã€‚");

      runBtn.disabled = true;
      runBtn.textContent = "è½¬æ¢ä¸­â€¦";
      log("\n--- å¼€å§‹æ–°ä»»åŠ¡ ---");

      let modelPath = "";
      try {
        ensureWorkDir();

        if (document.getElementById("autoClearBeforeRun").checked) {
          deleteAllInWorkDir();
          log("ğŸ§¹ å·²æ¸…ç©ºè¾“å‡ºåŒº");
        }

        const safeModelName = modelFile.name.replace(/[^\w.\-()+]/g, "_");
        modelPath = `${WORK_DIR}/${safeModelName}`;
        try { pnnxModule.FS.unlink(modelPath); } catch(e) {}

        log(`ğŸ“¦ å†™å…¥æ¨¡å‹: ${safeModelName} (${humanBytes(modelFile.size)})`);
        await writeFileToFS(modelFile, modelPath);
        log("âœ… æ¨¡å‹å†™å…¥å®Œæˆ");

        const built2 = buildArgs(modelPath);
        log(`ğŸ§¾ æ‰§è¡Œï¼špnnx ${built2.args.join(" ")}`);

        await new Promise(r => setTimeout(r, 60));

        try {
          pnnxModule.callMain(built2.args);
          log("âœ… pnnx æ‰§è¡Œç»“æŸ");
        } catch (execErr) {
          log("âŒ è¿è¡Œæ—¶é”™è¯¯: " + execErr);
          if (execErr && typeof execErr.status !== "undefined") log("é€€å‡ºç : " + execErr.status);
        }

        refreshFileListUI();

      } catch (e) {
        log("âŒ é”™è¯¯: " + e);
      } finally {
        if (modelPath) {
          try { pnnxModule.FS.unlink(modelPath); log("ğŸ§¹ å·²åˆ é™¤è¾“å…¥æ¨¡å‹æ–‡ä»¶"); } catch(e) {}
        }
        try { fileInput.value = ""; } catch(e) {}
        modelHint.textContent = "æœªé€‰æ‹©æ¨¡å‹";

        runBtn.disabled = false;
        runBtn.textContent = "å¼€å§‹è½¬æ¢";
      }
    });

    // âœ… å¯åŠ¨ï¼šåŠ è½½ pnnx.js + åˆå§‹åŒ– wasm
    (async function boot() {
      try {
        await loadScript(PNNX_JS);
      } catch (e) {
        dotWasm.classList.add("bad");
        wasmStatus.textContent = "åŠ è½½å¤±è´¥";
        log("âŒ " + e.message);
        return;
      }

      if (typeof createPnnxModule !== "function") {
        dotWasm.classList.add("bad");
        wasmStatus.textContent = "åŠ è½½å¤±è´¥";
        log("âŒ pnnx.js å·²åŠ è½½ï¼Œä½† createPnnxModule ä¸å­˜åœ¨ï¼ˆæ–‡ä»¶ä¸åŒ¹é…ï¼Ÿï¼‰");
        return;
      }

      createPnnxModule({
        locateFile: (path) => {
          if (path.endsWith(".wasm")) return PNNX_WASM;  // âœ… æŒ‰å¼€å…³é€‰æ‹© wasm
          return path;
        },
        print: (t)=>log(t),
        printErr: (t)=>{
          const s = String(t || "");
          // åŒä¿é™©ï¼šä¸åœ¨é¡µé¢æ—¥å¿—æ˜¾ç¤ºè¿™ä¸¤å¥
          if (s.includes("wasm streaming compile failed") ||
              s.includes("falling back to ArrayBuffer instantiation")) return;
          log("[STDERR] " + s);
        },
        setStatus: (t)=>{ if(t) log("[System] " + t); }
      }).then(instance => {
        pnnxModule = instance;
        ensureWorkDir();

        dotWasm.classList.add("ok");
        wasmStatus.textContent = "WASM å·²å°±ç»ª";

        runBtn.disabled = false;
        runBtn.textContent = "å¼€å§‹è½¬æ¢";
        clearLogBtn.disabled = false;
        refreshFilesBtn.disabled = false;
        clearWorkBtn.disabled = false;

        refreshFileListUI();
        log("âœ… PNNX æ¨¡å—åŠ è½½å®Œæˆã€‚");
      }).catch(err => {
        dotWasm.classList.add("bad");
        wasmStatus.textContent = "åŠ è½½å¤±è´¥";
        log("âŒ æ¨¡å—åŠ è½½å¤±è´¥: " + err);
      });
    })();
  </script>
</body>
</html>
